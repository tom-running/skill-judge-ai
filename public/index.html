<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>世界职业技能大赛 AI 评分系统</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@5.11.5/dist/reset.css">
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/antd@5.11.5/dist/antd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.5/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.2/dist/axios.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB',
        'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }
    #root {
      min-height: 100vh;
    }
    .status-pending { color: #8c8c8c; }
    .status-in_progress { color: #1890ff; }
    .status-finished { color: #52c41a; }
    .status-scoring { color: #fa8c16; }
    .status-scoring_finished { color: #722ed1; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const {
      Layout, Menu, Button, Form, Input, Table, Modal, Select, DatePicker,
      message, Card, Tag, Tabs, Upload, Space, Descriptions, InputNumber,
      Row, Col, Divider, Typography, Badge, Popconfirm, Drawer
    } = antd;
    const { Header, Content, Sider } = Layout;
    const { Option } = Select;
    const { Title, Text } = Typography;
    const { TextArea } = Input;

    // API配置
    axios.defaults.baseURL = '/api';

    // 设置Token
    const setAuthToken = (token) => {
      if (token) {
        axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
        localStorage.setItem('token', token);
      } else {
        delete axios.defaults.headers.common['Authorization'];
        localStorage.removeItem('token');
      }
    };

    // 初始化Token
    const token = localStorage.getItem('token');
    if (token) {
      setAuthToken(token);
    }

    // 登录组件
    function LoginPage({ onLogin }) {
      const [loading, setLoading] = useState(false);

      const onFinish = async (values) => {
        setLoading(true);
        try {
          const response = await axios.post('/auth/login', values);
          setAuthToken(response.data.token);
          onLogin(response.data.user);
          message.success('登录成功');
        } catch (error) {
          message.error(error.response?.data?.error || '登录失败');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div style={{
          display: 'flex',
          justifyContent: 'center',
          alignItems: 'center',
          minHeight: '100vh',
          background: '#f0f2f5'
        }}>
          <Card title="世界职业技能大赛 AI 评分系统" style={{ width: 400 }}>
            <Form onFinish={onFinish} layout="vertical">
              <Form.Item
                label="用户名"
                name="username"
                rules={[{ required: true, message: '请输入用户名' }]}
              >
                <Input />
              </Form.Item>
              <Form.Item
                label="密码"
                name="password"
                rules={[{ required: true, message: '请输入密码' }]}
              >
                <Input.Password />
              </Form.Item>
              <Form.Item>
                <Button type="primary" htmlType="submit" loading={loading} block>
                  登录
                </Button>
              </Form.Item>
            </Form>
            <Text type="secondary">默认管理员: admin / admin123</Text>
          </Card>
        </div>
      );
    }

    // 用户管理
    function UserManagement() {
      const [users, setUsers] = useState([]);
      const [loading, setLoading] = useState(false);
      const [modalVisible, setModalVisible] = useState(false);
      const [editingUser, setEditingUser] = useState(null);
      const [form] = Form.useForm();

      const loadUsers = async () => {
        setLoading(true);
        try {
          const response = await axios.get('/users');
          setUsers(response.data);
        } catch (error) {
          message.error('加载用户失败');
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => {
        loadUsers();
      }, []);

      const handleAdd = () => {
        setEditingUser(null);
        form.resetFields();
        setModalVisible(true);
      };

      const handleEdit = (user) => {
        setEditingUser(user);
        form.setFieldsValue(user);
        setModalVisible(true);
      };

      const handleDelete = async (id) => {
        try {
          await axios.delete(`/users/${id}`);
          message.success('删除成功');
          loadUsers();
        } catch (error) {
          message.error('删除失败');
        }
      };

      const handleSubmit = async (values) => {
        try {
          if (editingUser) {
            await axios.put(`/users/${editingUser.id}`, values);
            message.success('更新成功');
          } else {
            await axios.post('/users', values);
            message.success('创建成功');
          }
          setModalVisible(false);
          loadUsers();
        } catch (error) {
          message.error(error.response?.data?.error || '操作失败');
        }
      };

      const columns = [
        { title: 'ID', dataIndex: 'id', key: 'id' },
        { title: '用户名', dataIndex: 'username', key: 'username' },
        { title: '姓名', dataIndex: 'name', key: 'name' },
        {
          title: '角色',
          dataIndex: 'role',
          key: 'role',
          render: (role) => {
            const roleMap = {
              admin: { text: '管理员', color: 'red' },
              chief_judge: { text: '裁判长', color: 'blue' },
              judge: { text: '裁判', color: 'green' },
              contestant: { text: '选手', color: 'orange' }
            };
            const r = roleMap[role] || { text: role, color: 'default' };
            return <Tag color={r.color}>{r.text}</Tag>;
          }
        },
        {
          title: '操作',
          key: 'action',
          render: (_, record) => (
            <Space>
              <Button size="small" onClick={() => handleEdit(record)}>编辑</Button>
              <Button size="small" danger onClick={() => handleDelete(record.id)}>删除</Button>
            </Space>
          )
        }
      ];

      return (
        <div>
          <div style={{ marginBottom: 16 }}>
            <Button type="primary" onClick={handleAdd}>添加用户</Button>
          </div>
          <Table
            loading={loading}
            dataSource={users}
            columns={columns}
            rowKey="id"
          />
          <Modal
            title={editingUser ? '编辑用户' : '添加用户'}
            open={modalVisible}
            onCancel={() => setModalVisible(false)}
            footer={null}
          >
            <Form form={form} onFinish={handleSubmit} layout="vertical">
              {!editingUser && (
                <Form.Item
                  label="用户名"
                  name="username"
                  rules={[{ required: true }]}
                >
                  <Input />
                </Form.Item>
              )}
              <Form.Item
                label="姓名"
                name="name"
                rules={[{ required: true }]}
              >
                <Input />
              </Form.Item>
              <Form.Item
                label="角色"
                name="role"
                rules={[{ required: true }]}
              >
                <Select>
                  <Option value="admin">管理员</Option>
                  <Option value="chief_judge">裁判长</Option>
                  <Option value="judge">裁判</Option>
                  <Option value="contestant">选手</Option>
                </Select>
              </Form.Item>
              {!editingUser && (
                <Form.Item
                  label="密码"
                  name="password"
                  rules={[{ required: true }]}
                >
                  <Input.Password />
                </Form.Item>
              )}
              {editingUser && (
                <Form.Item label="新密码（留空表示不修改）" name="password">
                  <Input.Password />
                </Form.Item>
              )}
              <Form.Item>
                <Space>
                  <Button type="primary" htmlType="submit">提交</Button>
                  <Button onClick={() => setModalVisible(false)}>取消</Button>
                </Space>
              </Form.Item>
            </Form>
          </Modal>
        </div>
      );
    }

    // 赛事管理
    function CompetitionManagement({ user }) {
      const [competitions, setCompetitions] = useState([]);
      const [loading, setLoading] = useState(false);
      const [modalVisible, setModalVisible] = useState(false);
      const [editingItem, setEditingItem] = useState(null);
      const [form] = Form.useForm();

      const loadData = async () => {
        setLoading(true);
        try {
          const response = await axios.get('/competitions');
          setCompetitions(response.data);
        } catch (error) {
          if (error.response?.status === 403) {
            message.error('无权限访问：您没有权限查看赛事数据');
          } else {
            message.error('加载赛事失败');
          }
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => {
        loadData();
      }, []);

      const handleAdd = () => {
        if (user.role !== 'admin') {
          message.error('无权限：只有管理员才能新建赛事');
          return;
        }
        setEditingItem(null);
        form.resetFields();
        setModalVisible(true);
      };

      const handleEdit = (item) => {
        if (user.role !== 'admin') {
          message.error('无权限：只有管理员才能编辑赛事');
          return;
        }
        setEditingItem(item);
        form.setFieldsValue({
          ...item,
          start_time: item.start_time ? dayjs(item.start_time) : null,
          end_time: item.end_time ? dayjs(item.end_time) : null
        });
        setModalVisible(true);
      };

      const handleDelete = async (id) => {
        if (user.role !== 'admin') {
          message.error('无权限：只有管理员才能删除赛事');
          return;
        }
        try {
          await axios.delete(`/competitions/${id}`);
          message.success('删除成功');
          loadData();
        } catch (error) {
          if (error.response?.status === 403) {
            message.error('无权限：您没有权限删除此赛事');
          } else {
            message.error('删除失败');
          }
        }
      };

      const handleSubmit = async (values) => {
        try {
          const data = {
            ...values,
            start_time: values.start_time.toISOString(),
            end_time: values.end_time.toISOString()
          };
          if (editingItem) {
            await axios.put(`/competitions/${editingItem.id}`, data);
            message.success('更新成功');
          } else {
            await axios.post('/competitions', data);
            message.success('创建成功');
          }
          setModalVisible(false);
          loadData();
        } catch (error) {
          message.error('操作失败');
        }
      };

      const columns = [
        { title: 'ID', dataIndex: 'id', key: 'id', width: 80 },
        { title: '赛事名称', dataIndex: 'name', key: 'name' },
        {
          title: '开始时间',
          dataIndex: 'start_time',
          key: 'start_time',
          render: (val) => dayjs(val).format('YYYY-MM-DD HH:mm')
        },
        {
          title: '结束时间',
          dataIndex: 'end_time',
          key: 'end_time',
          render: (val) => dayjs(val).format('YYYY-MM-DD HH:mm')
        },
        {
          title: '操作',
          key: 'action',
          render: (_, record) => (
            <Space>
              {user.role === 'admin' ? (
                <>
                  <Button size="small" onClick={() => handleEdit(record)}>编辑</Button>
                  <Button size="small" danger onClick={() => handleDelete(record.id)}>删除</Button>
                </>
              ) : (
                <Text type="secondary">无操作权限</Text>
              )}
            </Space>
          )
        }
      ];

      return (
        <div>
          <div style={{ marginBottom: 16 }}>
            {user.role === 'admin' && (
              <Button type="primary" onClick={handleAdd}>添加赛事</Button>
            )}
          </div>
          <Table
            loading={loading}
            dataSource={competitions}
            columns={columns}
            rowKey="id"
          />
          <Modal
            title={editingItem ? '编辑赛事' : '添加赛事'}
            open={modalVisible}
            onCancel={() => setModalVisible(false)}
            footer={null}
            width={600}
          >
            <Form form={form} onFinish={handleSubmit} layout="vertical">
              <Form.Item label="赛事名称" name="name" rules={[{ required: true }]}>
                <Input />
              </Form.Item>
              <Form.Item label="开始时间" name="start_time" rules={[{ required: true }]}>
                <DatePicker showTime style={{ width: '100%' }} />
              </Form.Item>
              <Form.Item label="结束时间" name="end_time" rules={[{ required: true }]}>
                <DatePicker showTime style={{ width: '100%' }} />
              </Form.Item>
              <Form.Item>
                <Space>
                  <Button type="primary" htmlType="submit">提交</Button>
                  <Button onClick={() => setModalVisible(false)}>取消</Button>
                </Space>
              </Form.Item>
            </Form>
          </Modal>
        </div>
      );
    }

    // 赛项管理
    function EventManagement({ user }) {
      const [events, setEvents] = useState([]);
      const [competitions, setCompetitions] = useState([]);
      const [users, setUsers] = useState([]);
      const [loading, setLoading] = useState(false);
      const [modalVisible, setModalVisible] = useState(false);
      const [assignModalVisible, setAssignModalVisible] = useState(false);
      const [detailModalVisible, setDetailModalVisible] = useState(false);
      const [assignType, setAssignType] = useState('');
      const [selectedEvent, setSelectedEvent] = useState(null);
      const [eventDetail, setEventDetail] = useState(null);
      const [editingItem, setEditingItem] = useState(null);
      const [form] = Form.useForm();
      const [assignForm] = Form.useForm();

      const loadData = async () => {
        setLoading(true);
        try {
          const [eventsRes, competitionsRes, usersRes] = await Promise.all([
            axios.get('/events'),
            axios.get('/competitions'),
            axios.get('/users')
          ]);
          setEvents(eventsRes.data);
          setCompetitions(competitionsRes.data);
          setUsers(usersRes.data);
        } catch (error) {
          console.error('Load data error:', error);
          if (error.response) {
            message.error(`加载数据失败: ${error.response.data.error || error.response.status}`);
          } else {
            message.error('加载数据失败: 网络错误');
          }
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => {
        loadData();
      }, []);

      const handleAdd = () => {
        if (user.role !== 'admin') {
          message.error('无权限：只有管理员才能新建赛项');
          return;
        }
        setEditingItem(null);
        form.resetFields();
        setModalVisible(true);
      };

      const handleEdit = (item) => {
        if (user.role !== 'admin') {
          message.error('无权限：只有管理员才能编辑赛项');
          return;
        }
        setEditingItem(item);
        form.setFieldsValue({
          ...item,
          start_time: item.start_time ? dayjs(item.start_time) : null,
          end_time: item.end_time ? dayjs(item.end_time) : null
        });
        setModalVisible(true);
      };

      const handleDelete = async (id) => {
        if (user.role !== 'admin') {
          message.error('无权限：只有管理员才能删除赛项');
          return;
        }
        try {
          await axios.delete(`/events/${id}`);
          message.success('删除成功');
          loadData();
        } catch (error) {
          if (error.response?.status === 403) {
            message.error('无权限：您没有权限删除此赛项');
          } else {
            message.error('删除失败');
          }
        }
      };

      const handleSubmit = async (values) => {
        try {
          const data = {
            ...values,
            start_time: values.start_time.toISOString(),
            end_time: values.end_time.toISOString()
          };
          if (editingItem) {
            await axios.put(`/events/${editingItem.id}`, data);
            message.success('更新成功');
          } else {
            await axios.post('/events', data);
            message.success('创建成功');
          }
          setModalVisible(false);
          loadData();
        } catch (error) {
          message.error('操作失败');
        }
      };

      const handleAssign = (event, type) => {
        setSelectedEvent(event);
        setAssignType(type);
        assignForm.resetFields();
        setAssignModalVisible(true);
      };

      const handleAssignSubmit = async (values) => {
        try {
          if (assignType === 'chief_judge') {
            await axios.post(`/events/${selectedEvent.id}/chief-judges`, {
              chief_judge_id: values.user_id
            });
          } else if (assignType === 'judge') {
            await axios.post(`/events/${selectedEvent.id}/judges`, {
              judge_id: values.user_id
            });
          } else if (assignType === 'contestant') {
            await axios.post(`/events/${selectedEvent.id}/contestants`, {
              contestant_id: values.user_id
            });
          } else if (assignType === 'judge_contestant') {
            await axios.post(`/events/${selectedEvent.id}/judge-contestants`, values);
          }
          message.success('分配成功');
          setAssignModalVisible(false);
          loadData();
        } catch (error) {
          message.error('分配失败');
        }
      };

      const handleViewDetail = async (event) => {
        try {
          const response = await axios.get(`/events/${event.id}`);
          setEventDetail(response.data);
          setDetailModalVisible(true);
        } catch (error) {
          message.error('加载赛项详情失败');
        }
      };

      const handleRemoveAssignment = async (type, eventId, userId, userId2 = null) => {
        try {
          if (type === 'chief_judge') {
            await axios.delete(`/events/${eventId}/chief-judges/${userId}`);
          } else if (type === 'judge') {
            await axios.delete(`/events/${eventId}/judges/${userId}`);
          } else if (type === 'contestant') {
            await axios.delete(`/events/${eventId}/contestants/${userId}`);
          } else if (type === 'judge_contestant') {
            await axios.delete(`/events/${eventId}/judge-contestants?judge_id=${userId}&contestant_id=${userId2}`);
          }
          message.success('移除成功');
          handleViewDetail(eventDetail);
        } catch (error) {
          message.error('移除失败');
        }
      };

      const columns = [
        { title: 'ID', dataIndex: 'id', key: 'id', width: 60 },
        { title: '赛项名称', dataIndex: 'name', key: 'name' },
        { title: '赛事', dataIndex: 'competition_name', key: 'competition_name' },
        {
          title: '开始时间',
          dataIndex: 'start_time',
          key: 'start_time',
          render: (val) => dayjs(val).format('YYYY-MM-DD HH:mm')
        },
        {
          title: '操作',
          key: 'action',
          render: (_, record) => (
            <Space wrap>
              <Button size="small" onClick={() => handleViewDetail(record)}>查看详情</Button>
              {user.role === 'admin' && (
                <>
                  <Button size="small" onClick={() => handleEdit(record)}>编辑</Button>
                  <Button size="small" danger onClick={() => handleDelete(record.id)}>删除</Button>
                  <Button size="small" onClick={() => handleAssign(record, 'chief_judge')}>分配裁判长</Button>
                  <Button size="small" onClick={() => handleAssign(record, 'judge')}>分配裁判</Button>
                  <Button size="small" onClick={() => handleAssign(record, 'contestant')}>分配选手</Button>
                  <Button size="small" onClick={() => handleAssign(record, 'judge_contestant')}>分配裁判-选手</Button>
                </>
              )}
            </Space>
          ),
          width: 550
        }
      ];

      const getRoleUsers = () => {
        if (assignType === 'chief_judge') {
          return users.filter(u => u.role === 'chief_judge');
        } else if (assignType === 'judge') {
          return users.filter(u => u.role === 'judge');
        } else if (assignType === 'contestant') {
          return users.filter(u => u.role === 'contestant');
        }
        return users;
      };

      return (
        <div>
          <div style={{ marginBottom: 16 }}>
            {user.role === 'admin' && (
              <Button type="primary" onClick={handleAdd}>添加赛项</Button>
            )}
          </div>
          <Table
            loading={loading}
            dataSource={events}
            columns={columns}
            rowKey="id"
          />
          <Modal
            title={editingItem ? '编辑赛项' : '添加赛项'}
            open={modalVisible}
            onCancel={() => setModalVisible(false)}
            footer={null}
            width={600}
          >
            <Form form={form} onFinish={handleSubmit} layout="vertical">
              <Form.Item label="赛事" name="competition_id" rules={[{ required: true }]}>
                <Select>
                  {competitions.map(c => (
                    <Option key={c.id} value={c.id}>{c.name}</Option>
                  ))}
                </Select>
              </Form.Item>
              <Form.Item label="赛项名称" name="name" rules={[{ required: true }]}>
                <Input />
              </Form.Item>
              <Form.Item label="开始时间" name="start_time" rules={[{ required: true }]}>
                <DatePicker showTime style={{ width: '100%' }} />
              </Form.Item>
              <Form.Item label="结束时间" name="end_time" rules={[{ required: true }]}>
                <DatePicker showTime style={{ width: '100%' }} />
              </Form.Item>
              <Form.Item>
                <Space>
                  <Button type="primary" htmlType="submit">提交</Button>
                  <Button onClick={() => setModalVisible(false)}>取消</Button>
                </Space>
              </Form.Item>
            </Form>
          </Modal>
          <Modal
            title={`分配${assignType === 'chief_judge' ? '裁判长' : assignType === 'judge' ? '裁判' : assignType === 'contestant' ? '选手' : '裁判-选手'}`}
            open={assignModalVisible}
            onCancel={() => setAssignModalVisible(false)}
            footer={null}
          >
            <Form form={assignForm} onFinish={handleAssignSubmit} layout="vertical">
              {assignType === 'judge_contestant' ? (
                <>
                  <Form.Item label="裁判" name="judge_id" rules={[{ required: true }]}>
                    <Select>
                      {users.filter(u => u.role === 'judge').map(u => (
                        <Option key={u.id} value={u.id}>{u.name} ({u.username})</Option>
                      ))}
                    </Select>
                  </Form.Item>
                  <Form.Item label="选手" name="contestant_id" rules={[{ required: true }]}>
                    <Select>
                      {users.filter(u => u.role === 'contestant').map(u => (
                        <Option key={u.id} value={u.id}>{u.name} ({u.username})</Option>
                      ))}
                    </Select>
                  </Form.Item>
                </>
              ) : (
                <Form.Item label="用户" name="user_id" rules={[{ required: true }]}>
                  <Select>
                    {getRoleUsers().map(u => (
                      <Option key={u.id} value={u.id}>{u.name} ({u.username})</Option>
                    ))}
                  </Select>
                </Form.Item>
              )}
              <Form.Item>
                <Space>
                  <Button type="primary" htmlType="submit">提交</Button>
                  <Button onClick={() => setAssignModalVisible(false)}>取消</Button>
                </Space>
              </Form.Item>
            </Form>
          </Modal>
          <Modal
            title={`赛项详情 - ${eventDetail?.name}`}
            open={detailModalVisible}
            onCancel={() => setDetailModalVisible(false)}
            footer={null}
            width={1000}
          >
            {eventDetail && (
              <div>
                <Descriptions bordered column={2}>
                  <Descriptions.Item label="赛项名称">{eventDetail.name}</Descriptions.Item>
                  <Descriptions.Item label="赛事">{eventDetail.competition_name}</Descriptions.Item>
                  <Descriptions.Item label="开始时间">
                    {dayjs(eventDetail.start_time).format('YYYY-MM-DD HH:mm')}
                  </Descriptions.Item>
                  <Descriptions.Item label="结束时间">
                    {dayjs(eventDetail.end_time).format('YYYY-MM-DD HH:mm')}
                  </Descriptions.Item>
                </Descriptions>
                
                <Tabs defaultActiveKey="chief_judges" style={{ marginTop: 24 }}>
                  <Tabs.TabPane tab={`裁判长 (${eventDetail.chief_judges.length})`} key="chief_judges">
                    <Table
                      dataSource={eventDetail.chief_judges}
                      columns={[
                        { title: 'ID', dataIndex: 'id', key: 'id', width: 80 },
                        { title: '用户名', dataIndex: 'username', key: 'username' },
                        { title: '姓名', dataIndex: 'name', key: 'name' },
                        {
                          title: '操作',
                          key: 'action',
                          render: (_, record) => (
                            user.role === 'admin' ? (
                              <Button
                                size="small"
                                danger
                                onClick={() => handleRemoveAssignment('chief_judge', eventDetail.id, record.id)}
                              >
                                移除
                              </Button>
                            ) : null
                          )
                        }
                      ]}
                      rowKey="id"
                      pagination={false}
                      size="small"
                    />
                  </Tabs.TabPane>
                  <Tabs.TabPane tab={`裁判 (${eventDetail.judges.length})`} key="judges">
                    <Table
                      dataSource={eventDetail.judges}
                      columns={[
                        { title: 'ID', dataIndex: 'id', key: 'id', width: 80 },
                        { title: '用户名', dataIndex: 'username', key: 'username' },
                        { title: '姓名', dataIndex: 'name', key: 'name' },
                        {
                          title: '操作',
                          key: 'action',
                          render: (_, record) => (
                            user.role === 'admin' ? (
                              <Button
                                size="small"
                                danger
                                onClick={() => handleRemoveAssignment('judge', eventDetail.id, record.id)}
                              >
                                移除
                              </Button>
                            ) : null
                          )
                        }
                      ]}
                      rowKey="id"
                      pagination={false}
                      size="small"
                    />
                  </Tabs.TabPane>
                  <Tabs.TabPane tab={`选手 (${eventDetail.contestants.length})`} key="contestants">
                    <Table
                      dataSource={eventDetail.contestants}
                      columns={[
                        { title: 'ID', dataIndex: 'id', key: 'id', width: 80 },
                        { title: '用户名', dataIndex: 'username', key: 'username' },
                        { title: '姓名', dataIndex: 'name', key: 'name' },
                        {
                          title: '操作',
                          key: 'action',
                          render: (_, record) => (
                            user.role === 'admin' ? (
                              <Button
                                size="small"
                                danger
                                onClick={() => handleRemoveAssignment('contestant', eventDetail.id, record.id)}
                              >
                                移除
                              </Button>
                            ) : null
                          )
                        }
                      ]}
                      rowKey="id"
                      pagination={false}
                      size="small"
                    />
                  </Tabs.TabPane>
                  <Tabs.TabPane tab={`模块 (${eventDetail.modules?.length || 0})`} key="modules">
                    <Table
                      dataSource={eventDetail.modules}
                      columns={[
                        { title: 'ID', dataIndex: 'id', key: 'id', width: 80 },
                        { title: '模块名称', dataIndex: 'name', key: 'name' },
                        { title: '时长(分钟)', dataIndex: 'duration_minutes', key: 'duration_minutes' },
                        {
                          title: '状态',
                          dataIndex: 'status',
                          key: 'status',
                          render: (status) => {
                            const statusMap = {
                              pending: { text: '未开始', color: 'default' },
                              in_progress: { text: '进行中', color: 'processing' },
                              finished: { text: '已结束', color: 'success' },
                              scoring: { text: '评分中', color: 'warning' },
                              scoring_finished: { text: '评分结束', color: 'purple' }
                            };
                            const s = statusMap[status] || { text: status, color: 'default' };
                            return <Badge status={s.color} text={s.text} />;
                          }
                        }
                      ]}
                      rowKey="id"
                      pagination={false}
                      size="small"
                    />
                  </Tabs.TabPane>
                  <Tabs.TabPane tab="裁判-选手分配" key="assignments">
                    <JudgeContestantAssignments eventId={eventDetail.id} user={user} />
                  </Tabs.TabPane>
                </Tabs>
              </div>
            )}
          </Modal>
        </div>
      );
    }

    // 模块管理
    function ModuleManagement({ user }) {
      const [modules, setModules] = useState([]);
      const [events, setEvents] = useState([]);
      const [loading, setLoading] = useState(false);
      const [modalVisible, setModalVisible] = useState(false);
      const [criteriaModalVisible, setCriteriaModalVisible] = useState(false);
      const [attachmentModalVisible, setAttachmentModalVisible] = useState(false);
      const [selectedModule, setSelectedModule] = useState(null);
      const [scoringCriteria, setScoringCriteria] = useState(null);
      const [problemAttachments, setProblemAttachments] = useState([]);
      const [answerAttachments, setAnswerAttachments] = useState([]);
      const [editingItem, setEditingItem] = useState(null);
      const [form] = Form.useForm();
      const [itemForm] = Form.useForm();

      const loadData = async () => {
        setLoading(true);
        try {
          const [modulesRes, eventsRes] = await Promise.all([
            axios.get('/modules'),
            axios.get('/events')
          ]);
          setModules(modulesRes.data);
          setEvents(eventsRes.data);
        } catch (error) {
          message.error('加载数据失败');
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => {
        loadData();
      }, []);

      const handleAdd = () => {
        if (!['admin', 'chief_judge'].includes(user.role)) {
          message.error('无权限：只有管理员和裁判长才能新建模块');
          return;
        }
        setEditingItem(null);
        form.resetFields();
        setModalVisible(true);
      };

      const handleEdit = (item) => {
        if (!['admin', 'chief_judge'].includes(user.role)) {
          message.error('无权限：只有管理员和裁判长才能编辑模块');
          return;
        }
        setEditingItem(item);
        form.setFieldsValue(item);
        setModalVisible(true);
      };

      const handleDelete = async (id) => {
        if (!['admin', 'chief_judge'].includes(user.role)) {
          message.error('无权限：只有管理员和裁判长才能删除模块');
          return;
        }
        try {
          await axios.delete(`/modules/${id}`);
          message.success('删除成功');
          loadData();
        } catch (error) {
          if (error.response?.status === 403) {
            message.error('无权限：您没有权限删除此模块');
          } else {
            message.error('删除失败');
          }
        }
      };

      const handleSubmit = async (values) => {
        try {
          if (editingItem) {
            await axios.put(`/modules/${editingItem.id}`, values);
            message.success('更新成功');
          } else {
            await axios.post('/modules', values);
            message.success('创建成功');
          }
          setModalVisible(false);
          loadData();
        } catch (error) {
          message.error('操作失败');
        }
      };

      const handleStatusChange = async (id, status) => {
        try {
          await axios.patch(`/modules/${id}/status`, { status });
          message.success('状态更新成功');
          loadData();
        } catch (error) {
          message.error('状态更新失败');
        }
      };

      const handleManageCriteria = async (module) => {
        setSelectedModule(module);
        try {
          const response = await axios.get(`/scoring/modules/${module.id}/criteria`);
          setScoringCriteria(response.data);
          setCriteriaModalVisible(true);
        } catch (error) {
          message.error('加载评分标准失败');
        }
      };

      const handleManageAttachments = (module) => {
        // 选手在模块未开始时无法查看
        if (user.role === 'contestant' && module.status === 'pending') {
          message.error('模块尚未开始，无法查看赛题');
          return;
        }
        
        setSelectedModule(module);
        setAttachmentModalVisible(true);
        loadProblemAttachments(module.id);
        if (user.role === 'contestant') {
          loadAnswerAttachments(module.id, user.id);
        }
      };

      const handleCreateCriteria = async () => {
        try {
          const response = await axios.post(`/scoring/modules/${selectedModule.id}/criteria`);
          setScoringCriteria(response.data);
          message.success('创建成功');
        } catch (error) {
          message.error('创建失败');
        }
      };

      const handleAddItem = async (values) => {
        try {
          await axios.post(`/scoring/criteria/${scoringCriteria.id}/items`, values);
          message.success('添加成功');
          itemForm.resetFields();
          handleManageCriteria(selectedModule);
        } catch (error) {
          message.error('添加失败');
        }
      };

      const handleDeleteItem = async (itemId) => {
        try {
          await axios.delete(`/scoring/items/${itemId}`);
          message.success('删除成功');
          handleManageCriteria(selectedModule);
        } catch (error) {
          message.error('删除失败');
        }
      };

      const loadProblemAttachments = async (moduleId) => {
        try {
          const response = await axios.get(`/attachments/modules/${moduleId}/problem`);
          setProblemAttachments(response.data);
        } catch (error) {
          console.error('加载赛题附件失败:', error);
          setProblemAttachments([]);
        }
      };

      const loadAnswerAttachments = async (moduleId, contestantId) => {
        try {
          const response = await axios.get(`/attachments/modules/${moduleId}/contestants/${contestantId}/answer`);
          setAnswerAttachments(response.data);
        } catch (error) {
          console.error('加载答题附件失败:', error);
          setAnswerAttachments([]);
        }
      };

      const handleUploadProblem = async (info) => {
        if (info.file.status === 'done') {
          message.success('赛题上传成功');
          loadProblemAttachments(selectedModule.id);
        } else if (info.file.status === 'error') {
          message.error('赛题上传失败');
        }
      };

      const handleUploadAnswer = async (info) => {
        if (info.file.status === 'done') {
          message.success('答题上传成功');
          loadAnswerAttachments(selectedModule.id, user.id);
        } else if (info.file.status === 'error') {
          message.error('答题上传失败');
        }
      };

      const handleDeleteProblem = async (id) => {
        try {
          await axios.delete(`/attachments/problem/${id}`);
          message.success('删除成功');
          loadProblemAttachments(selectedModule.id);
        } catch (error) {
          message.error('删除失败');
        }
      };

      const handleDeleteAnswer = async (id) => {
        try {
          await axios.delete(`/attachments/answer/${id}`);
          message.success('删除成功');
          loadAnswerAttachments(selectedModule.id, user.id);
        } catch (error) {
          message.error('删除失败');
        }
      };

      const handleDownload = (filepath, filename) => {
        window.open(`/api/attachments/download?filepath=${encodeURIComponent(filepath)}`);
      };

      const columns = [
        { title: 'ID', dataIndex: 'id', key: 'id', width: 60 },
        { title: '模块名称', dataIndex: 'name', key: 'name' },
        {
          title: '赛项',
          dataIndex: 'event_id',
          key: 'event_id',
          render: (id) => events.find(e => e.id === id)?.name || '-'
        },
        {
          title: '时长(分钟)',
          dataIndex: 'duration_minutes',
          key: 'duration_minutes'
        },
        {
          title: '状态',
          dataIndex: 'status',
          key: 'status',
          render: (status) => {
            const statusMap = {
              pending: { text: '未开始', color: 'default' },
              in_progress: { text: '进行中', color: 'processing' },
              finished: { text: '已结束', color: 'success' },
              scoring: { text: '评分中', color: 'warning' },
              scoring_finished: { text: '评分结束', color: 'purple' }
            };
            const s = statusMap[status] || { text: status, color: 'default' };
            return <Badge status={s.color} text={s.text} />;
          }
        },
        {
          title: '操作',
          key: 'action',
          render: (_, record) => (
            <Space wrap>
              {['admin', 'chief_judge'].includes(user.role) && (
                <>
                  <Button size="small" onClick={() => handleEdit(record)}>编辑</Button>
                  <Select
                    size="small"
                    value={record.status}
                    onChange={(val) => handleStatusChange(record.id, val)}
                    style={{ width: 100 }}
                  >
                    <Option value="pending">未开始</Option>
                    <Option value="in_progress">进行中</Option>
                    <Option value="finished">已结束</Option>
                    <Option value="scoring">评分中</Option>
                    <Option value="scoring_finished">评分结束</Option>
                  </Select>
                  <Button size="small" onClick={() => handleManageCriteria(record)}>评分标准</Button>
                  <Button size="small" onClick={() => handleManageAttachments(record)}>赛题/答题</Button>
                  <Button size="small" danger onClick={() => handleDelete(record.id)}>删除</Button>
                </>
              )}
              {['judge', 'contestant'].includes(user.role) && (
                <Button 
                  size="small" 
                  onClick={() => handleManageAttachments(record)}
                  disabled={user.role === 'contestant' && record.status === 'pending'}
                >
                  {user.role === 'contestant' ? '查看赛题/答题' : '查看赛题/答题'}
                </Button>
              )}
            </Space>
          ),
          width: 380
        }
      ];

      return (
        <div>
          <div style={{ marginBottom: 16 }}>
            {['admin', 'chief_judge'].includes(user.role) && (
              <Button type="primary" onClick={handleAdd}>添加模块</Button>
            )}
          </div>
          <Table
            loading={loading}
            dataSource={modules}
            columns={columns}
            rowKey="id"
          />
          <Modal
            title={editingItem ? '编辑模块' : '添加模块'}
            open={modalVisible}
            onCancel={() => setModalVisible(false)}
            footer={null}
          >
            <Form form={form} onFinish={handleSubmit} layout="vertical">
              <Form.Item label="赛项" name="event_id" rules={[{ required: true }]}>
                <Select>
                  {events.map(e => (
                    <Option key={e.id} value={e.id}>{e.name}</Option>
                  ))}
                </Select>
              </Form.Item>
              <Form.Item label="模块名称" name="name" rules={[{ required: true }]}>
                <Input />
              </Form.Item>
              <Form.Item label="时长(分钟)" name="duration_minutes" rules={[{ required: true }]}>
                <InputNumber min={1} style={{ width: '100%' }} />
              </Form.Item>
              <Form.Item>
                <Space>
                  <Button type="primary" htmlType="submit">提交</Button>
                  <Button onClick={() => setModalVisible(false)}>取消</Button>
                </Space>
              </Form.Item>
            </Form>
          </Modal>
          <Modal
            title={`评分标准管理 - ${selectedModule?.name}`}
            open={criteriaModalVisible}
            onCancel={() => setCriteriaModalVisible(false)}
            footer={null}
            width={800}
          >
            {!scoringCriteria ? (
              <div style={{ textAlign: 'center', padding: 40 }}>
                <p>尚未创建评分标准</p>
                <Button type="primary" onClick={handleCreateCriteria}>创建评分标准</Button>
              </div>
            ) : (
              <div>
                <Title level={5}>评分项列表</Title>
                <Table
                  dataSource={scoringCriteria.items.filter(item => item.id)}
                  columns={[
                    { title: 'ID', dataIndex: 'id', key: 'id', width: 60 },
                    {
                      title: '描述',
                      dataIndex: 'description',
                      key: 'description',
                      ellipsis: true
                    },
                    {
                      title: '类型',
                      dataIndex: 'evaluation_type',
                      key: 'evaluation_type',
                      render: (type) => type === 'objective' ? '客观' : '主观'
                    },
                    {
                      title: '满分',
                      dataIndex: 'max_score',
                      key: 'max_score'
                    },
                    {
                      title: '操作',
                      key: 'action',
                      render: (_, record) => (
                        <Button size="small" danger onClick={() => handleDeleteItem(record.id)}>
                          删除
                        </Button>
                      )
                    }
                  ]}
                  rowKey="id"
                  pagination={false}
                  size="small"
                />
                <Divider />
                <Title level={5}>添加评分项</Title>
                <Form form={itemForm} onFinish={handleAddItem} layout="vertical">
                  <Form.Item
                    label="评分标准描述（支持富文本/HTML）"
                    name="description"
                    rules={[{ required: true }]}
                  >
                    <TextArea rows={3} />
                  </Form.Item>
                  <Form.Item label="评估类型" name="evaluation_type" rules={[{ required: true }]}>
                    <Select>
                      <Option value="objective">客观</Option>
                      <Option value="subjective">主观</Option>
                    </Select>
                  </Form.Item>
                  <Form.Item label="满分" name="max_score" rules={[{ required: true }]}>
                    <InputNumber min={0} step={0.01} style={{ width: '100%' }} />
                  </Form.Item>
                  <Form.Item label="排序" name="sort_order">
                    <InputNumber min={0} style={{ width: '100%' }} />
                  </Form.Item>
                  <Form.Item>
                    <Button type="primary" htmlType="submit">添加评分项</Button>
                  </Form.Item>
                </Form>
              </div>
            )}
          </Modal>
          <Modal
            title={`附件管理 - ${selectedModule?.name}`}
            open={attachmentModalVisible}
            onCancel={() => setAttachmentModalVisible(false)}
            footer={null}
            width={900}
          >
            <Tabs defaultActiveKey="problem">
              <Tabs.TabPane tab="赛题附件" key="problem">
                {['admin', 'chief_judge'].includes(user.role) && (
                  <div style={{ marginBottom: 16 }}>
                    <Upload
                      name="file"
                      action={`/api/attachments/modules/${selectedModule?.id}/problem`}
                      headers={{
                        Authorization: axios.defaults.headers.common['Authorization']
                      }}
                      onChange={handleUploadProblem}
                    >
                      <Button>上传赛题</Button>
                    </Upload>
                  </div>
                )}
                <Table
                  dataSource={problemAttachments}
                  columns={[
                    { title: '文件名', dataIndex: 'filename', key: 'filename' },
                    {
                      title: '上传时间',
                      dataIndex: 'created_at',
                      key: 'created_at',
                      render: (val) => dayjs(val).format('YYYY-MM-DD HH:mm')
                    },
                    {
                      title: '操作',
                      key: 'action',
                      render: (_, record) => (
                        <Space>
                          <Button
                            size="small"
                            onClick={() => handleDownload(record.filepath, record.filename)}
                          >
                            下载
                          </Button>
                          {['admin', 'chief_judge'].includes(user.role) && (
                            <Popconfirm
                              title="确定要删除这个赛题文件吗？"
                              onConfirm={() => handleDeleteProblem(record.id)}
                            >
                              <Button size="small" danger>删除</Button>
                            </Popconfirm>
                          )}
                        </Space>
                      )
                    }
                  ]}
                  rowKey="id"
                  pagination={false}
                />
              </Tabs.TabPane>
              {user.role === 'contestant' && (
                <Tabs.TabPane tab="我的答题" key="answer">
                  {selectedModule?.status === 'in_progress' && (
                    <div style={{ marginBottom: 16 }}>
                      <Upload
                        name="file"
                        action={`/api/attachments/modules/${selectedModule?.id}/answer`}
                        headers={{
                          Authorization: axios.defaults.headers.common['Authorization']
                        }}
                        onChange={handleUploadAnswer}
                      >
                        <Button>上传答题</Button>
                      </Upload>
                    </div>
                  )}
                  <Table
                    dataSource={answerAttachments}
                    columns={[
                      { title: '文件名', dataIndex: 'filename', key: 'filename' },
                      {
                        title: '上传时间',
                        dataIndex: 'created_at',
                        key: 'created_at',
                        render: (val) => dayjs(val).format('YYYY-MM-DD HH:mm')
                      },
                      {
                        title: '操作',
                        key: 'action',
                        render: (_, record) => (
                          <Space>
                            <Button
                              size="small"
                              onClick={() => handleDownload(record.filepath, record.filename)}
                            >
                              下载
                            </Button>
                            {selectedModule?.status === 'in_progress' && (
                              <Popconfirm
                                title="确定要删除这个答题文件吗？"
                                onConfirm={() => handleDeleteAnswer(record.id)}
                              >
                                <Button size="small" danger>删除</Button>
                              </Popconfirm>
                            )}
                          </Space>
                        )
                      }
                    ]}
                    rowKey="id"
                    pagination={false}
                  />
                </Tabs.TabPane>
              )}
              {user.role === 'judge' && (
                <Tabs.TabPane tab="选手答题" key="contestant_answers">
                  <ContestantAnswers moduleId={selectedModule?.id} user={user} />
                </Tabs.TabPane>
              )}
            </Tabs>
          </Modal>
        </div>
      );
    }

    // 裁判查看选手答题组件
    function ContestantAnswers({ moduleId, user }) {
      const [contestants, setContestants] = useState([]);
      const [selectedContestant, setSelectedContestant] = useState(null);
      const [answerAttachments, setAnswerAttachments] = useState([]);
      const [loading, setLoading] = useState(false);

      const loadMyContestants = async () => {
        try {
          const response = await axios.get(`/scoring/modules/${moduleId}/records`);
          setContestants(response.data);
        } catch (error) {
          console.error('加载选手列表失败:', error);
        }
      };

      const loadContestantAnswers = async (contestantId) => {
        setLoading(true);
        try {
          const response = await axios.get(`/attachments/modules/${moduleId}/contestants/${contestantId}/answer`);
          setAnswerAttachments(response.data);
        } catch (error) {
          console.error('加载选手答题失败:', error);
          setAnswerAttachments([]);
        } finally {
          setLoading(false);
        }
      };

      const handleDownload = (filepath, filename) => {
        window.open(`/api/attachments/download?filepath=${encodeURIComponent(filepath)}`);
      };

      useEffect(() => {
        if (moduleId) {
          loadMyContestants();
        }
      }, [moduleId]);

      useEffect(() => {
        if (selectedContestant) {
          loadContestantAnswers(selectedContestant);
        }
      }, [selectedContestant]);

      return (
        <div>
          <div style={{ marginBottom: 16 }}>
            <Select
              placeholder="选择要查看的选手"
              style={{ width: 300 }}
              onChange={setSelectedContestant}
              value={selectedContestant}
            >
              {contestants.map(c => (
                <Option key={c.contestant_id} value={c.contestant_id}>
                  {c.contestant_name} ({c.username})
                </Option>
              ))}
            </Select>
          </div>
          {selectedContestant && (
            <Table
              loading={loading}
              dataSource={answerAttachments}
              columns={[
                { title: '文件名', dataIndex: 'filename', key: 'filename' },
                {
                  title: '上传时间',
                  dataIndex: 'created_at',
                  key: 'created_at',
                  render: (val) => dayjs(val).format('YYYY-MM-DD HH:mm')
                },
                {
                  title: '操作',
                  key: 'action',
                  render: (_, record) => (
                    <Button
                      size="small"
                      onClick={() => handleDownload(record.filepath, record.filename)}
                    >
                      下载查看
                    </Button>
                  )
                }
              ]}
              rowKey="id"
              pagination={false}
            />
          )}
        </div>
      );
    }

    // 裁判-选手分配关系组件
    function JudgeContestantAssignments({ eventId, user }) {
      const [assignments, setAssignments] = useState([]);
      const [loading, setLoading] = useState(false);

      const loadAssignments = async () => {
        setLoading(true);
        try {
          const response = await axios.get(`/events/${eventId}/judge-contestants`);
          setAssignments(response.data);
        } catch (error) {
          console.error('加载分配关系失败:', error);
          setAssignments([]);
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => {
        if (eventId) {
          loadAssignments();
        }
      }, [eventId]);

      const handleRemoveAssignment = async (judgeId, contestantId) => {
        try {
          await axios.delete(`/events/${eventId}/judge-contestants?judge_id=${judgeId}&contestant_id=${contestantId}`);
          message.success('移除成功');
          loadAssignments();
        } catch (error) {
          message.error('移除失败');
        }
      };

      const columns = [
        { title: '裁判ID', dataIndex: 'judge_id', key: 'judge_id', width: 80 },
        { title: '裁判姓名', dataIndex: 'judge_name', key: 'judge_name' },
        { title: '选手ID', dataIndex: 'contestant_id', key: 'contestant_id', width: 80 },
        { title: '选手姓名', dataIndex: 'contestant_name', key: 'contestant_name' },
        {
          title: '操作',
          key: 'action',
          render: (_, record) => (
            user.role === 'admin' ? (
              <Button
                size="small"
                danger
                onClick={() => handleRemoveAssignment(record.judge_id, record.contestant_id)}
              >
                移除分配
              </Button>
            ) : null
          )
        }
      ];

      return (
        <Table
          loading={loading}
          dataSource={assignments}
          columns={columns}
          rowKey={(record) => `${record.judge_id}-${record.contestant_id}`}
          pagination={false}
          size="small"
        />
      );
    }

    // 评分管理
    function ScoringManagement({ user }) {
      const [modules, setModules] = useState([]);
      const [expandedRows, setExpandedRows] = useState([]);
      const [contestantsData, setContestantsData] = useState({});
      const [loading, setLoading] = useState(false);
      const [drawerVisible, setDrawerVisible] = useState(false);
      const [selectedContestant, setSelectedContestant] = useState(null);
      const [selectedModule, setSelectedModule] = useState(null);

      const loadModules = async () => {
        setLoading(true);
        try {
          const response = await axios.get('/modules');
          let filteredModules = response.data;
          
          // 裁判只能看到评分中和评分结束的模块
          if (user.role === 'judge') {
            filteredModules = response.data.filter(module => 
              module.status === 'scoring' || module.status === 'scoring_finished'
            );
          }
          
          setModules(filteredModules);
        } catch (error) {
          message.error('加载模块失败');
        } finally {
          setLoading(false);
        }
      };

      const loadContestants = async (moduleId) => {
        try {
          const [recordsResponse] = await Promise.all([
            axios.get(`/scoring/modules/${moduleId}/records`)
          ]);
          
          const contestants = recordsResponse.data || [];
          
          // 为每个选手加载答题附件
          const contestantsWithAttachments = await Promise.all(
            contestants.map(async (contestant) => {
              try {
                const attachmentResponse = await axios.get(
                  `/attachments/modules/${moduleId}/contestants/${contestant.contestant_id}/answer`
                );
                return {
                  ...contestant,
                  answerAttachments: attachmentResponse.data || []
                };
              } catch (error) {
                return {
                  ...contestant,
                  answerAttachments: []
                };
              }
            })
          );

          setContestantsData(prev => ({
            ...prev,
            [moduleId]: contestantsWithAttachments
          }));
        } catch (error) {
          message.error('加载选手数据失败');
          setContestantsData(prev => ({
            ...prev,
            [moduleId]: []
          }));
        }
      };

      useEffect(() => {
        loadModules();
      }, []);

      const handleExpand = (expanded, record) => {
        if (expanded) {
          setExpandedRows([...expandedRows, record.id]);
          loadContestants(record.id);
        } else {
          setExpandedRows(expandedRows.filter(id => id !== record.id));
        }
      };

      const handleUpdateScore = async (moduleId, contestantId, itemId, score) => {
        try {
          // 立即更新本地状态，提供即时反馈
          if (selectedContestant && selectedContestant.contestant_id === contestantId) {
            const updatedItemResults = selectedContestant.item_results.map(item => {
              if ((item.scoring_item_id || item.id) === itemId) {
                return { ...item, judge_score: score };
              }
              return item;
            });
            setSelectedContestant({
              ...selectedContestant,
              item_results: updatedItemResults
            });
          }

          // 同时更新主列表中的数据
          setContestantsData(prev => {
            const moduleContestants = prev[moduleId] || [];
            const updatedContestants = moduleContestants.map(contestant => {
              if (contestant.contestant_id === contestantId) {
                const updatedItemResults = contestant.item_results.map(item => {
                  if ((item.scoring_item_id || item.id) === itemId) {
                    return { ...item, judge_score: score };
                  }
                  return item;
                });
                return {
                  ...contestant,
                  item_results: updatedItemResults
                };
              }
              return contestant;
            });
            return {
              ...prev,
              [moduleId]: updatedContestants
            };
          });

          // 后台保存到服务器
          await axios.put(
            `/scoring/modules/${moduleId}/contestants/${contestantId}/score`,
            {
              scoring_item_id: itemId,
              judge_score: score
            }
          );
          
        } catch (error) {
          message.error('评分保存失败：' + (error.response?.data?.error || '网络错误'));
          // 如果保存失败，可以考虑恢复之前的状态
          console.error('评分保存失败:', error);
        }
      };

      const handleEditScoring = (contestant, module) => {
        setSelectedContestant(contestant);
        setSelectedModule(module);
        setDrawerVisible(true);
      };

      const handleCreateScoringRecord = async () => {
        try {
          const response = await axios.post(`/scoring/modules/${selectedModule.id}/contestants/${selectedContestant.contestant_id}/create-record`);
          message.success('创建评分记录成功');
          
          // 强制重新加载数据
          const refreshData = async () => {
            try {
              // 重新获取选手的详细数据
              const recordsResponse = await axios.get(`/scoring/modules/${selectedModule.id}/records`);
              const contestants = recordsResponse.data || [];
              
              // 为每个选手加载答题附件（保持原有逻辑）
              const contestantsWithAttachments = await Promise.all(
                contestants.map(async (contestant) => {
                  try {
                    const attachmentResponse = await axios.get(
                      `/attachments/modules/${selectedModule.id}/contestants/${contestant.contestant_id}/answer`
                    );
                    return {
                      ...contestant,
                      answerAttachments: attachmentResponse.data || []
                    };
                  } catch (error) {
                    return {
                      ...contestant,
                      answerAttachments: []
                    };
                  }
                })
              );

              // 更新主列表数据
              setContestantsData(prev => ({
                ...prev,
                [selectedModule.id]: contestantsWithAttachments
              }));

              // 找到并更新当前选手数据
              const updatedContestant = contestantsWithAttachments.find(c => c.contestant_id === selectedContestant.contestant_id);
              if (updatedContestant) {
                console.log('更新选手数据:', updatedContestant);
                setSelectedContestant(updatedContestant);
              }
            } catch (refreshError) {
              console.error('刷新数据失败:', refreshError);
              message.error('刷新数据失败，请手动关闭并重新打开评分界面');
            }
          };

          // 延迟刷新确保后端数据已更新
          setTimeout(refreshData, 800);
          
        } catch (error) {
          console.error('创建评分记录失败:', error);
          message.error('创建评分记录失败：' + (error.response?.data?.error || '未知错误'));
        }
      };

      const statusConfig = {
        pending: { text: '未开始', color: 'default' },
        in_progress: { text: '进行中', color: 'processing' },
        finished: { text: '已结束', color: 'success' },
        scoring: { text: '评分中', color: 'warning' },
        scoring_finished: { text: '评分结束', color: 'purple' }
      };

      const moduleColumns = [
        { title: '模块名称', dataIndex: 'name', key: 'name' },
        { 
          title: '状态', 
          dataIndex: 'status', 
          key: 'status',
          render: (status) => (
            <Tag color={statusConfig[status]?.color}>{statusConfig[status]?.text}</Tag>
          )
        },
        { title: '时长(分钟)', dataIndex: 'duration_minutes', key: 'duration_minutes' },
        {
          title: '选手数量',
          key: 'contestant_count',
          render: (_, record) => (
            contestantsData[record.id] ? contestantsData[record.id].length : '-'
          )
        }
      ];

      const expandedRowRender = (moduleRecord) => {
        const contestants = contestantsData[moduleRecord.id] || [];
        
        if (contestants.length === 0) {
          return <div style={{ padding: 16, textAlign: 'center' }}>没有选手数据</div>;
        }

        const contestantColumns = [
          { title: '选手', dataIndex: 'contestant_name', key: 'contestant_name', width: 120 },
          { title: '用户名', dataIndex: 'username', key: 'username', width: 100 },
          {
            title: '答题文件',
            key: 'attachments',
            width: 200,
            render: (_, record) => (
              <div>
                {record.answerAttachments?.map(attachment => (
                  <div key={attachment.id} style={{ marginBottom: 4 }}>
                    <Button 
                      type="link" 
                      size="small"
                      onClick={() => window.open(`/attachments/download?filepath=${encodeURIComponent(attachment.filepath)}`, '_blank')}
                    >
                      {attachment.filename}
                    </Button>
                  </div>
                ))}
                {(!record.answerAttachments || record.answerAttachments.length === 0) && (
                  <Text type="secondary">未上传</Text>
                )}
              </div>
            )
          },
          {
            title: '总分',
            key: 'total_score',
            width: 120,
            render: (_, record) => {
              const items = record.item_results.filter(item => item.id || item.scoring_item_id);
              const judgeTotal = items.reduce((sum, item) => sum + (parseFloat(item.judge_score) || 0), 0);
              const aiTotal = items.reduce((sum, item) => sum + (parseFloat(item.ai_score) || 0), 0);
              return (
                <div>
                  <div>裁判: {judgeTotal.toFixed(1)}</div>
                  <div>AI: {aiTotal.toFixed(1)}</div>
                </div>
              );
            }
          },
          {
            title: '操作',
            key: 'action',
            width: 100,
            render: (_, record) => (
              <Button
                type="primary"
                size="small"
                onClick={() => handleEditScoring(record, moduleRecord)}
                disabled={moduleRecord.status === 'scoring_finished'}
              >
                评分
              </Button>
            )
          }
        ];

        return (
          <Table
            columns={contestantColumns}
            dataSource={contestants}
            pagination={false}
            size="small"
            scroll={{ x: 800 }}
            rowKey="id"
          />
        );
      };

      return (
        <div>
          <div style={{ marginBottom: 16 }}>
            <Text strong>评分管理</Text>
            <Text type="secondary" style={{ marginLeft: 16 }}>
              展开模块行查看选手答题和评分
            </Text>
          </div>
          
          <Table
            loading={loading}
            columns={moduleColumns}
            dataSource={modules}
            rowKey="id"
            expandable={{
              expandedRowKeys: expandedRows,
              onExpand: handleExpand,
              expandedRowRender: expandedRowRender
            }}
            pagination={{ pageSize: 10 }}
          />

          {/* 详细评分抽屉 */}
          <Drawer
            title={`详细评分 - ${selectedContestant?.contestant_name || ''}`}
            placement="right"
            open={drawerVisible}
            onClose={() => setDrawerVisible(false)}
            width="80%"
          >
            {selectedContestant && selectedModule && (
              <div>
                {/* 选手基本信息 */}
                <Card size="small" style={{ marginBottom: 16 }}>
                  <Descriptions column={2} size="small">
                    <Descriptions.Item label="选手姓名">{selectedContestant.contestant_name}</Descriptions.Item>
                    <Descriptions.Item label="用户名">{selectedContestant.username}</Descriptions.Item>
                    <Descriptions.Item label="模块状态">
                      <Tag color={statusConfig[selectedModule.status]?.color}>
                        {statusConfig[selectedModule.status]?.text}
                      </Tag>
                    </Descriptions.Item>
                  </Descriptions>
                </Card>

                {/* 答题文件 */}
                {selectedContestant.answerAttachments && selectedContestant.answerAttachments.length > 0 && (
                  <Card title="答题文件" size="small" style={{ marginBottom: 16 }}>
                    <div>
                      {selectedContestant.answerAttachments.map(attachment => (
                        <div key={attachment.id} style={{ marginBottom: 8 }}>
                          <Button 
                            type="link" 
                            onClick={() => window.open(`/attachments/download?filepath=${encodeURIComponent(attachment.filepath)}`, '_blank')}
                          >
                            {attachment.filename}
                          </Button>
                          <Text type="secondary" style={{ marginLeft: 16 }}>
                            上传时间: {new Date(attachment.created_at).toLocaleString()}
                          </Text>
                        </div>
                      ))}
                    </div>
                  </Card>
                )}

                {/* 详细评分项 */}
                <Card title="评分详情" size="small">
                  {(() => {
                    const validItems = selectedContestant.item_results.filter(item => item.id || item.scoring_item_id);
                    console.log('选手评分记录:', selectedContestant.item_results);
                    console.log('有效评分项数量:', validItems.length);
                    return validItems.length === 0;
                  })() ? (
                    <div style={{ textAlign: 'center', padding: 40 }}>
                      <Text type="secondary">该选手尚未创建评分记录</Text>
                      <br />
                      <Button 
                        type="primary" 
                        onClick={handleCreateScoringRecord}
                        disabled={selectedModule.status === 'scoring_finished'}
                        style={{ marginTop: 16 }}
                      >
                        创建评分记录
                      </Button>
                    </div>
                  ) : null}

                  {/* 总分汇总 - 只在有评分记录时显示 */}
                  {selectedContestant.item_results.filter(item => item.id || item.scoring_item_id).length > 0 && (
                    <>
                      <Card size="small" style={{ backgroundColor: '#f0f2f5' }}>
                        <Row gutter={16}>
                          <Col span={12}>
                            <Text strong>裁判总分: </Text>
                            <Text style={{ fontSize: '18px', color: '#1890ff' }}>
                              {selectedContestant.item_results
                                .filter(item => item.id || item.scoring_item_id)
                                .reduce((sum, item) => sum + (parseFloat(item.judge_score) || 0), 0)
                                .toFixed(1)}
                            </Text>
                          </Col>
                          <Col span={12}>
                            <Text strong>AI总分: </Text>
                            <Text style={{ fontSize: '18px', color: '#52c41a' }}>
                              {selectedContestant.item_results
                                .filter(item => item.id || item.scoring_item_id)
                                .reduce((sum, item) => sum + (parseFloat(item.ai_score) || 0), 0)
                                .toFixed(1)}
                            </Text>
                          </Col>
                        </Row>
                      </Card>

                      {/* 详细评分明细 */}
                      <Card title="评分明细表" size="small" style={{ marginTop: 16 }}>
                        <Table
                          dataSource={selectedContestant.item_results.filter(item => item.id || item.scoring_item_id)}
                          columns={[
                        {
                          title: '序号',
                          key: 'index',
                          width: 60,
                          render: (_, record, index) => index + 1
                        },
                        {
                          title: '评分项',
                          dataIndex: 'description',
                          key: 'description',
                          width: 250,
                          render: (text) => (
                            <div 
                              dangerouslySetInnerHTML={{ __html: text }} 
                              style={{ maxWidth: '240px', overflow: 'hidden' }}
                            />
                          )
                        },
                        {
                          title: '类型',
                          dataIndex: 'evaluation_type',
                          key: 'evaluation_type',
                          width: 80,
                          render: (type) => (
                            <Tag color={type === 'objective' ? 'blue' : 'green'}>
                              {type === 'objective' ? '客观' : '主观'}
                            </Tag>
                          )
                        },
                        {
                          title: '满分',
                          dataIndex: 'max_score',
                          key: 'max_score',
                          width: 80,
                          render: (score) => <Text strong>{score}</Text>
                        },
                        {
                          title: 'AI评分',
                          dataIndex: 'ai_score',
                          key: 'ai_score',
                          width: 90,
                          render: (score) => (
                            score !== null && score !== undefined ? (
                              <Tag color="blue">{parseFloat(score).toFixed(1)}</Tag>
                            ) : (
                              <Text type="secondary">未评分</Text>
                            )
                          )
                        },
                        {
                          title: 'AI评估建议',
                          dataIndex: 'ai_suggestion',
                          key: 'ai_suggestion',
                          width: 200,
                          render: (suggestion) => (
                            suggestion ? (
                              <div 
                                style={{
                                  fontSize: '12px',
                                  color: '#666',
                                  backgroundColor: '#f6f8fa',
                                  padding: '6px 8px',
                                  borderRadius: '4px',
                                  maxWidth: '190px',
                                  overflow: 'hidden',
                                  textOverflow: 'ellipsis',
                                  whiteSpace: 'nowrap',
                                  cursor: 'help'
                                }}
                                title={suggestion}
                              >
                                {suggestion}
                              </div>
                            ) : (
                              <Text type="secondary" style={{ fontSize: '12px' }}>暂无建议</Text>
                            )
                          )
                        },
                        {
                          title: '裁判评分',
                          dataIndex: 'judge_score',
                          key: 'judge_score',
                          width: 120,
                          render: (score, record) => (
                            <InputNumber
                              min={0}
                              max={record.max_score}
                              step={0.01}
                              value={score}
                              onChange={(val) => handleUpdateScore(selectedModule.id, selectedContestant.contestant_id, record.scoring_item_id || record.id, val)}
                              disabled={selectedModule.status === 'scoring_finished'}
                              style={{ width: 100 }}
                              placeholder="0"
                            />
                          )
                        },
                        {
                          title: '评分差异',
                          key: 'score_diff',
                          width: 90,
                          render: (_, record) => {
                            const aiScore = parseFloat(record.ai_score) || 0;
                            const judgeScore = parseFloat(record.judge_score) || 0;
                            const diff = Math.abs(aiScore - judgeScore);
                            
                            if (record.ai_score === null || record.judge_score === null) {
                              return <Text type="secondary">-</Text>;
                            }
                            
                            const color = diff <= 2 ? '#52c41a' : diff <= 5 ? '#faad14' : '#f5222d';
                            return (
                              <Text style={{ color, fontWeight: 'bold' }}>
                                {diff.toFixed(1)}
                              </Text>
                            );
                          }
                        }
                      ]}
                      pagination={false}
                      size="small"
                      rowKey={(record) => record.id || record.scoring_item_id || Math.random()}
                      scroll={{ x: 1000 }}
                    />
                      </Card>
                    </>
                  )}
                </Card>
              </div>
            )}
          </Drawer>
        </div>
      );
    }

    // 选手专用界面
    function ContestantInterface({ user, onLogout }) {
      const [currentModule, setCurrentModule] = useState(null);
      const [problemAttachments, setProblemAttachments] = useState([]);
      const [answerAttachments, setAnswerAttachments] = useState([]);
      const [loading, setLoading] = useState(false);

      const loadInProgressModule = async () => {
        setLoading(true);
        try {
          const response = await axios.get('/modules');
          const inProgressModules = response.data.filter(module => module.status === 'in_progress');
          
          if (inProgressModules.length > 0) {
            setCurrentModule(inProgressModules[0]);
            loadProblemAttachments(inProgressModules[0].id);
            loadAnswerAttachments(inProgressModules[0].id, user.id);
          } else {
            setCurrentModule(null);
          }
        } catch (error) {
          message.error('加载模块失败');
        } finally {
          setLoading(false);
        }
      };

      const loadProblemAttachments = async (moduleId) => {
        try {
          const response = await axios.get(`/attachments/modules/${moduleId}/problem`);
          setProblemAttachments(response.data);
        } catch (error) {
          console.error('加载赛题附件失败:', error);
          setProblemAttachments([]);
        }
      };

      const loadAnswerAttachments = async (moduleId, contestantId) => {
        try {
          const response = await axios.get(`/attachments/modules/${moduleId}/contestants/${contestantId}/answer`);
          setAnswerAttachments(response.data);
        } catch (error) {
          console.error('加载答题附件失败:', error);
          setAnswerAttachments([]);
        }
      };

      const handleUploadAnswer = async (info) => {
        if (info.file.status === 'done') {
          message.success('答题上传成功');
          loadAnswerAttachments(currentModule.id, user.id);
        } else if (info.file.status === 'error') {
          message.error('答题上传失败');
        }
      };

      const handleDeleteAnswer = async (id) => {
        try {
          await axios.delete(`/attachments/answer/${id}`);
          message.success('删除成功');
          loadAnswerAttachments(currentModule.id, user.id);
        } catch (error) {
          message.error('删除失败');
        }
      };

      const handleDownload = (filepath, filename) => {
        window.open(`/api/attachments/download?filepath=${encodeURIComponent(filepath)}`);
      };

      useEffect(() => {
        loadInProgressModule();
        // 每30秒刷新一次，检查是否有新的进行中模块
        const interval = setInterval(loadInProgressModule, 30000);
        return () => clearInterval(interval);
      }, []);

      if (loading) {
        return (
          <div style={{ 
            display: 'flex', 
            justifyContent: 'center', 
            alignItems: 'center', 
            minHeight: '100vh' 
          }}>
            <Card>
              <div style={{ textAlign: 'center', padding: '20px' }}>
                <div>正在加载比赛信息...</div>
              </div>
            </Card>
          </div>
        );
      }

      if (!currentModule) {
        return (
          <Layout style={{ minHeight: '100vh' }}>
            <Header style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
              <div style={{ color: 'white', fontSize: '18px', fontWeight: 'bold' }}>
                世界职业技能大赛 AI 评分系统
              </div>
              <div style={{ color: 'white' }}>
                <Space>
                  <span>{user.name} (选手)</span>
                  <Button type="link" onClick={onLogout} style={{ color: 'white' }}>
                    退出
                  </Button>
                </Space>
              </div>
            </Header>
            <Content style={{ 
              display: 'flex', 
              justifyContent: 'center', 
              alignItems: 'center', 
              minHeight: 'calc(100vh - 64px)' 
            }}>
              <Card style={{ width: 400, textAlign: 'center' }}>
                <Title level={3}>暂无进行中的模块</Title>
                <p>请等待比赛开始</p>
                <Button onClick={loadInProgressModule}>刷新</Button>
              </Card>
            </Content>
          </Layout>
        );
      }

      return (
        <Layout style={{ minHeight: '100vh' }}>
          <Header style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
            <div style={{ color: 'white', fontSize: '18px', fontWeight: 'bold' }}>
              {currentModule.name} - 比赛进行中
            </div>
            <div style={{ color: 'white' }}>
              <Space>
                <span>{user.name} (选手)</span>
                <Button type="link" onClick={onLogout} style={{ color: 'white' }}>
                  退出
                </Button>
              </Space>
            </div>
          </Header>
          <Content style={{ padding: '24px' }}>
            <Row gutter={24}>
              <Col span={12}>
                <Card title="赛题附件" style={{ height: '100%' }}>
                  {problemAttachments.length === 0 ? (
                    <div style={{ textAlign: 'center', padding: '40px', color: '#999' }}>
                      暂无赛题文件
                    </div>
                  ) : (
                    <Table
                      dataSource={problemAttachments}
                      columns={[
                        { title: '文件名', dataIndex: 'filename', key: 'filename' },
                        {
                          title: '上传时间',
                          dataIndex: 'created_at',
                          key: 'created_at',
                          render: (val) => dayjs(val).format('YYYY-MM-DD HH:mm')
                        },
                        {
                          title: '操作',
                          key: 'action',
                          render: (_, record) => (
                            <Button
                              size="small"
                              onClick={() => handleDownload(record.filepath, record.filename)}
                            >
                              下载
                            </Button>
                          )
                        }
                      ]}
                      rowKey="id"
                      pagination={false}
                      size="small"
                    />
                  )}
                </Card>
              </Col>
              <Col span={12}>
                <Card title="我的答题" style={{ height: '100%' }}>
                  <div style={{ marginBottom: 16 }}>
                    <Upload
                      name="file"
                      action={`/api/attachments/modules/${currentModule.id}/answer`}
                      headers={{
                        Authorization: axios.defaults.headers.common['Authorization']
                      }}
                      onChange={handleUploadAnswer}
                      multiple
                    >
                      <Button type="primary" style={{ width: '100%' }}>上传答题文件</Button>
                    </Upload>
                  </div>
                  {answerAttachments.length === 0 ? (
                    <div style={{ textAlign: 'center', padding: '40px', color: '#999' }}>
                      暂未上传答题文件
                    </div>
                  ) : (
                    <Table
                      dataSource={answerAttachments}
                      columns={[
                        { title: '文件名', dataIndex: 'filename', key: 'filename' },
                        {
                          title: '上传时间',
                          dataIndex: 'created_at',
                          key: 'created_at',
                          render: (val) => dayjs(val).format('YYYY-MM-DD HH:mm')
                        },
                        {
                          title: '操作',
                          key: 'action',
                          render: (_, record) => (
                            <Space>
                              <Button
                                size="small"
                                onClick={() => handleDownload(record.filepath, record.filename)}
                              >
                                下载
                              </Button>
                              <Popconfirm
                                title="确定要删除这个文件吗？"
                                onConfirm={() => handleDeleteAnswer(record.id)}
                              >
                                <Button size="small" danger>删除</Button>
                              </Popconfirm>
                            </Space>
                          )
                        }
                      ]}
                      rowKey="id"
                      pagination={false}
                      size="small"
                    />
                  )}
                </Card>
              </Col>
            </Row>
          </Content>
        </Layout>
      );
    }

    // 主应用
    function App() {
      const [user, setUser] = useState(null);
      const [selectedMenu, setSelectedMenu] = useState('competitions');

      useEffect(() => {
        const token = localStorage.getItem('token');
        if (token) {
          axios.get('/auth/profile')
            .then(response => {
              const userData = response.data.user;
              setUser(userData);
              // 根据用户角色设置默认菜单
              if (userData.role === 'judge') {
                setSelectedMenu('scoring');
              }
            })
            .catch(() => {
              localStorage.removeItem('token');
              setAuthToken(null);
            });
        }
      }, []);

      const handleLogout = () => {
        setUser(null);
        setAuthToken(null);
      };

      if (!user) {
        return <LoginPage onLogin={setUser} />;
      }

      // 选手使用专用界面
      if (user.role === 'contestant') {
        return <ContestantInterface user={user} onLogout={handleLogout} />;
      }

      const menuItems = [
        { key: 'competitions', label: '赛事管理', roles: ['admin', 'chief_judge'] },
        { key: 'events', label: '赛项管理', roles: ['admin', 'chief_judge'] },
        { key: 'modules', label: '模块管理', roles: ['admin', 'chief_judge'] },
        { key: 'scoring', label: '评分管理', roles: ['admin', 'chief_judge', 'judge'] },
        { key: 'users', label: '用户管理', roles: ['admin'] },
      ].filter(item => item.roles.includes(user.role));

      const renderContent = () => {
        switch (selectedMenu) {
          case 'users':
            return <UserManagement />;
          case 'competitions':
            return <CompetitionManagement user={user} />;
          case 'events':
            return <EventManagement user={user} />;
          case 'modules':
            return <ModuleManagement user={user} />;
          case 'scoring':
            return <ScoringManagement user={user} />;
          default:
            return <div>选择一个菜单项</div>;
        }
      };

      return (
        <Layout style={{ minHeight: '100vh' }}>
          <Header style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
            <div style={{ color: 'white', fontSize: '18px', fontWeight: 'bold' }}>
              世界职业技能大赛 AI 评分系统
            </div>
            <div style={{ color: 'white' }}>
              <Space>
                <span>{user.name} ({user.role})</span>
                <Button type="link" onClick={handleLogout} style={{ color: 'white' }}>
                  退出
                </Button>
              </Space>
            </div>
          </Header>
          <Layout>
            <Sider width={200} style={{ background: '#fff' }}>
              <Menu
                mode="inline"
                selectedKeys={[selectedMenu]}
                style={{ height: '100%', borderRight: 0 }}
                items={menuItems}
                onSelect={({ key }) => setSelectedMenu(key)}
              />
            </Sider>
            <Layout style={{ padding: '24px' }}>
              <Content
                style={{
                  padding: 24,
                  margin: 0,
                  minHeight: 280,
                  background: '#fff',
                }}
              >
                {renderContent()}
              </Content>
            </Layout>
          </Layout>
        </Layout>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
