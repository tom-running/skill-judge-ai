<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸–ç•ŒæŠ€èƒ½å¤§èµ› AI è¯„åˆ†ç³»ç»Ÿ</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ†</text></svg>">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@5.11.5/dist/reset.css">
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/antd@5.11.5/dist/antd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.5/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.2/dist/axios.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #1a73e8;
      --primary-dark: #1557b0;
      --primary-light: #4285f4;
      --secondary-color: #00bfa5;
      --success-color: #00c853;
      --warning-color: #ff6d00;
      --error-color: #dd2c00;
      --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --tech-gradient: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      --surface-dark: #1a1d29;
      --surface-light: #ffffff;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --border-color: #e5e7eb;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
    
    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB',
        'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }
    
    #root {
      min-height: 100vh;
    }

    /* å…¨å±€å¡ç‰‡æ ·å¼ */
    .ant-card {
      border-radius: 12px !important;
      box-shadow: var(--shadow-md) !important;
      border: 1px solid var(--border-color) !important;
      transition: all 0.3s ease !important;
    }
    
    .ant-card:hover {
      box-shadow: var(--shadow-lg) !important;
      transform: translateY(-2px);
    }

    /* border-bottom: 2px solid var(--primary-color) !important; */
    .ant-card-head {
      background: linear-gradient(135deg, #f8fafc, #f1f5f9) !important;
      font-weight: 600 !important;
    }

    /* è¡¨æ ¼ä¼˜åŒ– */
    .ant-table {
      background: white;
      border-radius: 8px !important;
      overflow: hidden;
    }
    
    .ant-table-thead > tr > th {
      background: linear-gradient(to bottom, #f8fafc, #f1f5f9) !important;
      color: var(--text-primary) !important;
      font-weight: 600 !important;
      border-bottom: 2px solid var(--primary-color) !important;
      padding: 16px !important;
    }
    
    .ant-table-tbody > tr:hover > td {
      background: #f0f9ff !important;
    }
    
    .ant-table-tbody > tr > td {
      padding: 14px 16px !important;
      border-bottom: 1px solid #f0f0f0;
    }

    /* æŒ‰é’®ä¼˜åŒ– */
    .ant-btn-primary {
      background: var(--primary-color) !important;
      border: none !important;
      box-shadow: 0 2px 4px rgba(26, 115, 232, 0.3) !important;
      font-weight: 500 !important;
      border-radius: 6px !important;
      transition: all 0.3s ease !important;
    }
    
    .ant-btn-primary:hover {
      background: var(--primary-dark) !important;
      box-shadow: 0 4px 8px rgba(26, 115, 232, 0.4) !important;
      transform: translateY(-1px);
    }

    .ant-btn {
      border-radius: 6px !important;
      font-weight: 500 !important;
    }

    /* Modal ä¼˜åŒ– */
    .ant-modal-header {
      background: var(--tech-gradient) !important;
      border-radius: 8px 8px 0 0 !important;
      padding: 20px 24px !important;
      border-bottom: none !important;
    }
    
    .ant-modal-title {
      color: white !important;
      font-weight: 600 !important;
      font-size: 18px !important;
    }
    
    .ant-modal-close {
      color: white !important;
    }
    
    .ant-modal-close:hover {
      background: rgba(255, 255, 255, 0.2) !important;
    }
    
    .ant-modal-content {
      border-radius: 8px !important;
      overflow: hidden;
      box-shadow: var(--shadow-xl) !important;
    }

    /* Drawer ä¼˜åŒ– */
    .ant-drawer-header {
      background: var(--tech-gradient) !important;
      border-bottom: none !important;
      padding: 24px !important;
    }
    
    .ant-drawer-title {
      color: white !important;
      font-weight: 600 !important;
      font-size: 18px !important;
    }
    
    .ant-drawer-close {
      color: white !important;
    }

    .ant-drawer-close:hover {
      background: rgba(255, 255, 255, 0.2) !important;
    }

    /* Tag ä¼˜åŒ–  padding: 4px 12px !important; */
    .ant-tag {
      border-radius: 12px !important;
      font-weight: 500 !important;
      border: none !important;
    }

    /* Badge ä¼˜åŒ– */
    .ant-badge-status-text {
      font-weight: 500 !important;
    }

    /* Layout Header ä¼˜åŒ– */
    .ant-layout-header {
      background: var(--tech-gradient) !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
      padding: 0 24px !important;
      height: 64px !important;
      line-height: 64px !important;
    }

    /* Sider ä¼˜åŒ– */
    .ant-layout-sider {
      background: var(--surface-light) !important;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05) !important;
    }

    /* Menu ä¼˜åŒ– */
    .ant-menu-item-selected {
      background: linear-gradient(135deg, rgba(26, 115, 232, 0.15), rgba(26, 115, 232, 0.05)) !important;
      border-radius: 8px !important;
      color: var(--primary-color) !important;
      font-weight: 600 !important;
    }
    
    .ant-menu-item:hover {
      background: rgba(26, 115, 232, 0.08) !important;
      border-radius: 8px !important;
      color: var(--primary-color) !important;
    }

    .ant-menu-item {
      margin: 4px !important;
      padding: 4px 0 !important;
      height: auto !important;
      line-height: normal !important;
      border-radius: 8px !important;
    }

    .ant-menu-inline {
      border-right: none !important;
    }

    /* Form ä¼˜åŒ– */
    .ant-form-item-label > label {
      font-weight: 500 !important;
      color: var(--text-primary) !important;
    }
    
    .ant-input, .ant-input-number, .ant-select-selector, .ant-picker {
      border-radius: 6px !important;
      border: 1px solid var(--border-color) !important;
      transition: all 0.3s ease !important;
    }
    
    .ant-input:focus, .ant-input-number-focused .ant-input-number-input, 
    .ant-select-focused .ant-select-selector, .ant-picker-focused {
      border-color: var(--primary-color) !important;
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1) !important;
    }

    /* ç™»å½•é¡µé¢è¾“å…¥æ¡†æ ·å¼ */
    .login-page-form .ant-input,
    .login-page-form .ant-input-password {
      border: none !important;
      background: #f5f5f5 !important;
    }
    
    .login-page-form .ant-input:focus,
    .login-page-form .ant-input-password .ant-input:focus {
      background: #fff !important;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1) !important;
    }

    /* çŠ¶æ€é¢œè‰² */
    .status-pending { color: #8c8c8c; }
    .status-in_progress { color: #1890ff; }
    .status-finished { color: #52c41a; }
    .status-scoring { color: #fa8c16; }
    .status-scoring_finished { color: #722ed1; }

    /* ç«èµ›ç³»ç»Ÿç‰¹è‰²æ ·å¼ */
    .tech-header {
      background: var(--tech-gradient);
      color: white;
      padding: 16px 24px;
      border-radius: 8px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-lg);
    }
    
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 14px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .score-display {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* æ•°æ®å¯è§†åŒ–ä¼˜åŒ– */
    .data-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--shadow-md);
      border-left: 4px solid var(--primary-color);
      transition: all 0.3s ease;
    }
    
    .data-card:hover {
      box-shadow: var(--shadow-lg);
      transform: translateX(4px);
    }

    /* æ»šåŠ¨æ¡ä¼˜åŒ– */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }

    /* Tabs ä¼˜åŒ– */
    .ant-tabs-tab {
      font-weight: 500 !important;
      padding: 12px 0 !important;
    }

    .ant-tabs-tab-active .ant-tabs-tab-btn {
      color: var(--primary-color) !important;
      font-weight: 600 !important;
    }

    .ant-tabs-ink-bar {
      background: var(--primary-color) !important;
      height: 3px !important;
    }

    /* Descriptions ä¼˜åŒ– */
    .ant-descriptions-item-label {
      font-weight: 600 !important;
      color: var(--text-primary) !important;
    }

    /* Select ä¼˜åŒ– */
    .ant-select-dropdown {
      border-radius: 8px !important;
      box-shadow: var(--shadow-lg) !important;
    }

    /* Upload ä¼˜åŒ– */
    .ant-upload-list-item {
      border-radius: 6px !important;
    }

    /* Divider ä¼˜åŒ– */
    .ant-divider {
      border-color: var(--border-color) !important;
    }

    /* Space ä¼˜åŒ– */
    .ant-space-item {
      display: inline-flex;
      align-items: center;
    }

    /* Popconfirm ä¼˜åŒ– */
    .ant-popover-inner {
      border-radius: 8px !important;
      box-shadow: var(--shadow-lg) !important;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const {
      Layout, Menu, Button, Form, Input, Table, Modal, Select, DatePicker,
      message, Card, Tag, Tabs, Upload, Space, Descriptions, InputNumber,
      Row, Col, Divider, Typography, Badge, Popconfirm, Drawer
    } = antd;
    const { Header, Content, Sider } = Layout;
    const { Option } = Select;
    const { Title, Text } = Typography;
    const { TextArea } = Input;

    // APIé…ç½®
    axios.defaults.baseURL = '/api';

    // è®¾ç½®Token
    const setAuthToken = (token) => {
      if (token) {
        axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
        localStorage.setItem('token', token);
      } else {
        delete axios.defaults.headers.common['Authorization'];
        localStorage.removeItem('token');
      }
    };

    // åˆå§‹åŒ–Token
    const token = localStorage.getItem('token');
    if (token) {
      setAuthToken(token);
    }

    // ç™»å½•ç»„ä»¶
    function LoginPage({ onLogin }) {
      const [loading, setLoading] = useState(false);

      const onFinish = async (values) => {
        setLoading(true);
        try {
          const response = await axios.post('/auth/login', values);
          setAuthToken(response.data.token);
          onLogin(response.data.user);
          message.success('ç™»å½•æˆåŠŸ');
        } catch (error) {
          message.error(error.response?.data?.error || 'ç™»å½•å¤±è´¥');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div style={{
          display: 'flex',
          justifyContent: 'center',
          alignItems: 'center',
          minHeight: '100vh',
          background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
          position: 'relative',
          overflow: 'hidden'
        }}>
          {/* èƒŒæ™¯è£…é¥° */}
          <div style={{
            position: 'absolute',
            width: '100%',
            height: '100%',
            opacity: 0.1,
            background: `
              radial-gradient(circle at 20% 50%, white 1px, transparent 1px),
              radial-gradient(circle at 80% 80%, white 1px, transparent 1px)
            `,
            backgroundSize: '50px 50px'
          }}></div>

          <Card 
            style={{ 
              width: 450,
              boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
              borderRadius: '16px',
              overflow: 'hidden',
              border: 'none'
            }}
            bodyStyle={{ padding: '48px' }}
          >
            {/* Logo & Title */}
            <div style={{ textAlign: 'center', marginBottom: '40px' }}>
              <div style={{
                width: '80px',
                height: '80px',
                margin: '0 auto 24px',
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                borderRadius: '20px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                boxShadow: '0 8px 16px rgba(102, 126, 234, 0.4)'
              }}>
                <span style={{ fontSize: '36px', color: 'white' }}>ğŸ†</span>
              </div>
              <Title level={2} style={{ 
                margin: '0 0 8px 0',
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                WebkitBackgroundClip: 'text',
                WebkitTextFillColor: 'transparent',
                backgroundClip: 'text',
                fontWeight: 700
              }}>
                ä¸–ç•ŒæŠ€èƒ½å¤§èµ›
              </Title>
              <Text type="secondary" style={{ fontSize: '16px', fontWeight: 500 }}>
                AI æ™ºèƒ½è¯„åˆ†ç³»ç»Ÿ
              </Text>
            </div>

            <Form onFinish={onFinish} layout="vertical" size="large" className="login-page-form">
              <Form.Item
                label="ç”¨æˆ·å"
                name="username"
                rules={[{ required: true, message: 'è¯·è¾“å…¥ç”¨æˆ·å' }]}
              >
                <Input 
                  prefix={<span style={{ marginRight: 8 }}>ğŸ‘¤</span>}
                  placeholder="è¯·è¾“å…¥ç”¨æˆ·å" 
                  style={{ height: '48px' }}
                />
              </Form.Item>
              <Form.Item
                label="å¯†ç "
                name="password"
                rules={[{ required: true, message: 'è¯·è¾“å…¥å¯†ç ' }]}
              >
                <Input.Password 
                  prefix={<span style={{ marginRight: 8 }}>ğŸ”’</span>}
                  placeholder="è¯·è¾“å…¥å¯†ç " 
                  style={{ height: '48px' }}
                />
              </Form.Item>
              <Form.Item style={{ marginBottom: 0 }}>
                <Button 
                  type="primary" 
                  htmlType="submit" 
                  loading={loading} 
                  block
                  style={{ 
                    height: '48px',
                    fontSize: '16px',
                    fontWeight: 600,
                    marginTop: '16px'
                  }}
                >
                  ç™»å½•ç³»ç»Ÿ
                </Button>
              </Form.Item>
            </Form>

            {/* åº•éƒ¨æç¤º */}
            <div style={{ 
              marginTop: '32px', 
              textAlign: 'center',
              padding: '16px',
              background: '#f8fafc',
              borderRadius: '8px'
            }}>
              <Text type="secondary" style={{ fontSize: '13px' }}>
                ğŸ” é»˜è®¤ç®¡ç†å‘˜: admin / admin123
              </Text>
            </div>
          </Card>
        </div>
      );
    }

    // ç”¨æˆ·ç®¡ç†
    function UserManagement() {
      const [users, setUsers] = useState([]);
      const [loading, setLoading] = useState(false);
      const [modalVisible, setModalVisible] = useState(false);
      const [editingUser, setEditingUser] = useState(null);
      const [form] = Form.useForm();

      const loadUsers = async () => {
        setLoading(true);
        try {
          const response = await axios.get('/users');
          setUsers(response.data);
        } catch (error) {
          message.error('åŠ è½½ç”¨æˆ·å¤±è´¥');
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => {
        loadUsers();
      }, []);

      const handleAdd = () => {
        setEditingUser(null);
        form.resetFields();
        setModalVisible(true);
      };

      const handleEdit = (user) => {
        setEditingUser(user);
        form.setFieldsValue(user);
        setModalVisible(true);
      };

      const handleDelete = async (id) => {
        try {
          await axios.delete(`/users/${id}`);
          message.success('åˆ é™¤æˆåŠŸ');
          loadUsers();
        } catch (error) {
          message.error('åˆ é™¤å¤±è´¥');
        }
      };

      const handleSubmit = async (values) => {
        try {
          if (editingUser) {
            await axios.put(`/users/${editingUser.id}`, values);
            message.success('æ›´æ–°æˆåŠŸ');
          } else {
            await axios.post('/users', values);
            message.success('åˆ›å»ºæˆåŠŸ');
          }
          setModalVisible(false);
          loadUsers();
        } catch (error) {
          message.error(error.response?.data?.error || 'æ“ä½œå¤±è´¥');
        }
      };

      const columns = [
        { title: 'ID', dataIndex: 'id', key: 'id' },
        { title: 'ç”¨æˆ·å', dataIndex: 'username', key: 'username' },
        { title: 'å§“å', dataIndex: 'name', key: 'name' },
        {
          title: 'è§’è‰²',
          dataIndex: 'role',
          key: 'role',
          render: (role) => {
            const roleMap = {
              admin: { text: 'ç®¡ç†å‘˜', color: 'red' },
              chief_judge: { text: 'è£åˆ¤é•¿', color: 'blue' },
              judge: { text: 'è£åˆ¤', color: 'green' },
              contestant: { text: 'é€‰æ‰‹', color: 'orange' }
            };
            const r = roleMap[role] || { text: role, color: 'default' };
            return <Tag color={r.color}>{r.text}</Tag>;
          }
        },
        {
          title: 'æ“ä½œ',
          key: 'action',
          render: (_, record) => (
            <Space>
              <Button size="small" onClick={() => handleEdit(record)}>ç¼–è¾‘</Button>
              <Button size="small" danger onClick={() => handleDelete(record.id)}>åˆ é™¤</Button>
            </Space>
          )
        }
      ];

      return (
        <div>
          {/* é¡µé¢æ ‡é¢˜ */}
          <div style={{
            marginBottom: '24px',
            padding: '20px 24px',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            borderRadius: '12px',
            color: 'white',
            boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
          }}>
            <div>
              <Title level={3} style={{ color: 'white', margin: 0 }}>
                ğŸ‘¥ ç”¨æˆ·ç®¡ç†
              </Title>
              <Text style={{ color: 'rgba(255,255,255,0.9)', fontSize: '14px' }}>
                ç®¡ç†ç³»ç»Ÿç”¨æˆ·è´¦å·å’Œæƒé™
              </Text>
            </div>
            <Button 
              onClick={handleAdd}
              size="large"
              style={{
                background: 'rgba(255,255,255,0.2)',
                border: '1px solid rgba(255,255,255,0.3)',
                color: 'white',
                fontWeight: 500
              }}
            >
              â• æ·»åŠ ç”¨æˆ·
            </Button>
          </div>

          <Table
            loading={loading}
            dataSource={users}
            columns={columns}
            rowKey="id"
          />
          <Drawer
            title={editingUser ? 'ç¼–è¾‘ç”¨æˆ·' : 'æ·»åŠ ç”¨æˆ·'}
            open={modalVisible}
            onClose={() => setModalVisible(false)}
            width={480}
          >
            <Form form={form} onFinish={handleSubmit} layout="vertical">
              {!editingUser && (
                <Form.Item
                  label="ç”¨æˆ·å"
                  name="username"
                  rules={[{ required: true }]}
                >
                  <Input />
                </Form.Item>
              )}
              <Form.Item
                label="å§“å"
                name="name"
                rules={[{ required: true }]}
              >
                <Input />
              </Form.Item>
              <Form.Item
                label="è§’è‰²"
                name="role"
                rules={[{ required: true }]}
              >
                <Select>
                  <Option value="admin">ç®¡ç†å‘˜</Option>
                  <Option value="chief_judge">è£åˆ¤é•¿</Option>
                  <Option value="judge">è£åˆ¤</Option>
                  <Option value="contestant">é€‰æ‰‹</Option>
                </Select>
              </Form.Item>
              {!editingUser && (
                <Form.Item
                  label="å¯†ç "
                  name="password"
                  rules={[{ required: true }]}
                >
                  <Input.Password />
                </Form.Item>
              )}
              {editingUser && (
                <Form.Item label="æ–°å¯†ç ï¼ˆç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹ï¼‰" name="password">
                  <Input.Password />
                </Form.Item>
              )}
              <Form.Item>
                <Space>
                  <Button type="primary" htmlType="submit">æäº¤</Button>
                  <Button onClick={() => setModalVisible(false)}>å–æ¶ˆ</Button>
                </Space>
              </Form.Item>
            </Form>
          </Drawer>
        </div>
      );
    }

    // èµ›äº‹ç®¡ç†
    function CompetitionManagement({ user }) {
      const [competitions, setCompetitions] = useState([]);
      const [loading, setLoading] = useState(false);
      const [modalVisible, setModalVisible] = useState(false);
      const [editingItem, setEditingItem] = useState(null);
      const [form] = Form.useForm();

      const loadData = async () => {
        setLoading(true);
        try {
          const response = await axios.get('/competitions');
          setCompetitions(response.data);
        } catch (error) {
          if (error.response?.status === 403) {
            message.error('æ— æƒé™è®¿é—®ï¼šæ‚¨æ²¡æœ‰æƒé™æŸ¥çœ‹èµ›äº‹æ•°æ®');
          } else {
            message.error('åŠ è½½èµ›äº‹å¤±è´¥');
          }
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => {
        loadData();
      }, []);

      const handleAdd = () => {
        if (user.role !== 'admin') {
          message.error('æ— æƒé™ï¼šåªæœ‰ç®¡ç†å‘˜æ‰èƒ½æ–°å»ºèµ›äº‹');
          return;
        }
        setEditingItem(null);
        form.resetFields();
        setModalVisible(true);
      };

      const handleEdit = (item) => {
        if (user.role !== 'admin') {
          message.error('æ— æƒé™ï¼šåªæœ‰ç®¡ç†å‘˜æ‰èƒ½ç¼–è¾‘èµ›äº‹');
          return;
        }
        setEditingItem(item);
        form.setFieldsValue({
          ...item,
          start_time: item.start_time ? dayjs(item.start_time) : null,
          end_time: item.end_time ? dayjs(item.end_time) : null
        });
        setModalVisible(true);
      };

      const handleDelete = async (id) => {
        if (user.role !== 'admin') {
          message.error('æ— æƒé™ï¼šåªæœ‰ç®¡ç†å‘˜æ‰èƒ½åˆ é™¤èµ›äº‹');
          return;
        }
        try {
          await axios.delete(`/competitions/${id}`);
          message.success('åˆ é™¤æˆåŠŸ');
          loadData();
        } catch (error) {
          if (error.response?.status === 403) {
            message.error('æ— æƒé™ï¼šæ‚¨æ²¡æœ‰æƒé™åˆ é™¤æ­¤èµ›äº‹');
          } else {
            message.error('åˆ é™¤å¤±è´¥');
          }
        }
      };

      const handleSubmit = async (values) => {
        try {
          const data = {
            ...values,
            start_time: values.start_time.toISOString(),
            end_time: values.end_time.toISOString()
          };
          if (editingItem) {
            await axios.put(`/competitions/${editingItem.id}`, data);
            message.success('æ›´æ–°æˆåŠŸ');
          } else {
            await axios.post('/competitions', data);
            message.success('åˆ›å»ºæˆåŠŸ');
          }
          setModalVisible(false);
          loadData();
        } catch (error) {
          message.error('æ“ä½œå¤±è´¥');
        }
      };

      const columns = [
        { title: 'ID', dataIndex: 'id', key: 'id', width: 80 },
        { title: 'èµ›äº‹åç§°', dataIndex: 'name', key: 'name' },
        {
          title: 'å¼€å§‹æ—¶é—´',
          dataIndex: 'start_time',
          key: 'start_time',
          render: (val) => dayjs(val).format('YYYY-MM-DD HH:mm')
        },
        {
          title: 'ç»“æŸæ—¶é—´',
          dataIndex: 'end_time',
          key: 'end_time',
          render: (val) => dayjs(val).format('YYYY-MM-DD HH:mm')
        },
        {
          title: 'æ“ä½œ',
          key: 'action',
          render: (_, record) => (
            <Space>
              {user.role === 'admin' ? (
                <>
                  <Button size="small" onClick={() => handleEdit(record)}>ç¼–è¾‘</Button>
                  <Button size="small" danger onClick={() => handleDelete(record.id)}>åˆ é™¤</Button>
                </>
              ) : (
                <Text type="secondary">æ— æ“ä½œæƒé™</Text>
              )}
            </Space>
          )
        }
      ];

      return (
        <div>
          {/* é¡µé¢æ ‡é¢˜ */}
          <div style={{
            marginBottom: '24px',
            padding: '20px 24px',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            borderRadius: '12px',
            color: 'white',
            boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
          }}>
            <div>
              <Title level={3} style={{ color: 'white', margin: 0 }}>
                ğŸ† èµ›äº‹ç®¡ç†
              </Title>
              <Text style={{ color: 'rgba(255,255,255,0.9)', fontSize: '14px' }}>
                ç®¡ç†ä¸–ç•ŒæŠ€èƒ½å¤§èµ›çš„å„é¡¹èµ›äº‹ä¿¡æ¯
              </Text>
            </div>
            {user.role === 'admin' && (
              <Button 
                onClick={handleAdd}
                size="large"
                style={{
                  background: 'rgba(255,255,255,0.2)',
                  border: '1px solid rgba(255,255,255,0.3)',
                  color: 'white',
                  fontWeight: 500
                }}
              >
                â• æ·»åŠ èµ›äº‹
              </Button>
            )}
          </div>

          <Table
            loading={loading}
            dataSource={competitions}
            columns={columns}
            rowKey="id"
          />
          <Drawer
            title={editingItem ? 'ç¼–è¾‘èµ›äº‹' : 'æ·»åŠ èµ›äº‹'}
            open={modalVisible}
            onClose={() => setModalVisible(false)}
            width={600}
          >
            <Form form={form} onFinish={handleSubmit} layout="vertical">
              <Form.Item label="èµ›äº‹åç§°" name="name" rules={[{ required: true }]}>
                <Input />
              </Form.Item>
              <Form.Item label="å¼€å§‹æ—¶é—´" name="start_time" rules={[{ required: true }]}>
                <DatePicker showTime style={{ width: '100%' }} />
              </Form.Item>
              <Form.Item label="ç»“æŸæ—¶é—´" name="end_time" rules={[{ required: true }]}>
                <DatePicker showTime style={{ width: '100%' }} />
              </Form.Item>
              <Form.Item>
                <Space>
                  <Button type="primary" htmlType="submit">æäº¤</Button>
                  <Button onClick={() => setModalVisible(false)}>å–æ¶ˆ</Button>
                </Space>
              </Form.Item>
            </Form>
          </Drawer>
        </div>
      );
    }

    // èµ›é¡¹ç®¡ç†
    function EventManagement({ user }) {
      const [events, setEvents] = useState([]);
      const [competitions, setCompetitions] = useState([]);
      const [users, setUsers] = useState([]);
      const [loading, setLoading] = useState(false);
      const [modalVisible, setModalVisible] = useState(false);
      const [assignModalVisible, setAssignModalVisible] = useState(false);
      const [detailModalVisible, setDetailModalVisible] = useState(false);
      const [assignType, setAssignType] = useState('');
      const [selectedEvent, setSelectedEvent] = useState(null);
      const [eventDetail, setEventDetail] = useState(null);
      const [editingItem, setEditingItem] = useState(null);
      const [form] = Form.useForm();
      const [assignForm] = Form.useForm();

      const loadData = async () => {
        setLoading(true);
        try {
          const [eventsRes, competitionsRes, usersRes] = await Promise.all([
            axios.get('/events'),
            axios.get('/competitions'),
            axios.get('/users')
          ]);
          setEvents(eventsRes.data);
          setCompetitions(competitionsRes.data);
          setUsers(usersRes.data);
        } catch (error) {
          console.error('Load data error:', error);
          if (error.response) {
            message.error(`åŠ è½½æ•°æ®å¤±è´¥: ${error.response.data.error || error.response.status}`);
          } else {
            message.error('åŠ è½½æ•°æ®å¤±è´¥: ç½‘ç»œé”™è¯¯');
          }
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => {
        loadData();
      }, []);

      const handleAdd = () => {
        if (user.role !== 'admin') {
          message.error('æ— æƒé™ï¼šåªæœ‰ç®¡ç†å‘˜æ‰èƒ½æ–°å»ºèµ›é¡¹');
          return;
        }
        setEditingItem(null);
        form.resetFields();
        setModalVisible(true);
      };

      const handleEdit = (item) => {
        if (user.role !== 'admin') {
          message.error('æ— æƒé™ï¼šåªæœ‰ç®¡ç†å‘˜æ‰èƒ½ç¼–è¾‘èµ›é¡¹');
          return;
        }
        setEditingItem(item);
        form.setFieldsValue({
          ...item,
          start_time: item.start_time ? dayjs(item.start_time) : null,
          end_time: item.end_time ? dayjs(item.end_time) : null
        });
        setModalVisible(true);
      };

      const handleDelete = async (id) => {
        if (user.role !== 'admin') {
          message.error('æ— æƒé™ï¼šåªæœ‰ç®¡ç†å‘˜æ‰èƒ½åˆ é™¤èµ›é¡¹');
          return;
        }
        try {
          await axios.delete(`/events/${id}`);
          message.success('åˆ é™¤æˆåŠŸ');
          loadData();
        } catch (error) {
          if (error.response?.status === 403) {
            message.error('æ— æƒé™ï¼šæ‚¨æ²¡æœ‰æƒé™åˆ é™¤æ­¤èµ›é¡¹');
          } else {
            message.error('åˆ é™¤å¤±è´¥');
          }
        }
      };

      const handleSubmit = async (values) => {
        try {
          const data = {
            ...values,
            start_time: values.start_time.toISOString(),
            end_time: values.end_time.toISOString()
          };
          if (editingItem) {
            await axios.put(`/events/${editingItem.id}`, data);
            message.success('æ›´æ–°æˆåŠŸ');
          } else {
            await axios.post('/events', data);
            message.success('åˆ›å»ºæˆåŠŸ');
          }
          setModalVisible(false);
          loadData();
        } catch (error) {
          message.error('æ“ä½œå¤±è´¥');
        }
      };

      const handleAssign = (event, type) => {
        setSelectedEvent(event);
        setAssignType(type);
        assignForm.resetFields();
        setAssignModalVisible(true);
      };

      const handleAssignSubmit = async (values) => {
        try {
          if (assignType === 'chief_judge') {
            await axios.post(`/events/${selectedEvent.id}/chief-judges`, {
              chief_judge_id: values.user_id
            });
          } else if (assignType === 'judge') {
            await axios.post(`/events/${selectedEvent.id}/judges`, {
              judge_id: values.user_id
            });
          } else if (assignType === 'contestant') {
            await axios.post(`/events/${selectedEvent.id}/contestants`, {
              contestant_id: values.user_id
            });
          } else if (assignType === 'judge_contestant') {
            await axios.post(`/events/${selectedEvent.id}/judge-contestants`, values);
          }
          message.success('åˆ†é…æˆåŠŸ');
          setAssignModalVisible(false);
          loadData();
        } catch (error) {
          message.error('åˆ†é…å¤±è´¥');
        }
      };

      const handleViewDetail = async (event) => {
        try {
          const response = await axios.get(`/events/${event.id}`);
          setEventDetail(response.data);
          setDetailModalVisible(true);
        } catch (error) {
          message.error('åŠ è½½èµ›é¡¹è¯¦æƒ…å¤±è´¥');
        }
      };

      const handleRemoveAssignment = async (type, eventId, userId, userId2 = null) => {
        try {
          if (type === 'chief_judge') {
            await axios.delete(`/events/${eventId}/chief-judges/${userId}`);
          } else if (type === 'judge') {
            await axios.delete(`/events/${eventId}/judges/${userId}`);
          } else if (type === 'contestant') {
            await axios.delete(`/events/${eventId}/contestants/${userId}`);
          } else if (type === 'judge_contestant') {
            await axios.delete(`/events/${eventId}/judge-contestants?judge_id=${userId}&contestant_id=${userId2}`);
          }
          message.success('ç§»é™¤æˆåŠŸ');
          handleViewDetail(eventDetail);
        } catch (error) {
          message.error('ç§»é™¤å¤±è´¥');
        }
      };

      const columns = [
        { title: 'ID', dataIndex: 'id', key: 'id', width: 60 },
        { title: 'èµ›é¡¹åç§°', dataIndex: 'name', key: 'name' },
        { title: 'èµ›äº‹', dataIndex: 'competition_name', key: 'competition_name' },
        {
          title: 'å¼€å§‹æ—¶é—´',
          dataIndex: 'start_time',
          key: 'start_time',
          render: (val) => dayjs(val).format('YYYY-MM-DD HH:mm')
        },
        {
          title: 'æ“ä½œ',
          key: 'action',
          render: (_, record) => {
            const { Dropdown } = antd;
            
            if (user.role === 'admin') {
              const menuItems = [
                {
                  key: 'edit',
                  label: 'ç¼–è¾‘',
                  onClick: () => handleEdit(record)
                },
                {
                  key: 'assign_chief_judge',
                  label: 'åˆ†é…è£åˆ¤é•¿',
                  onClick: () => handleAssign(record, 'chief_judge')
                },
                {
                  key: 'assign_judge',
                  label: 'åˆ†é…è£åˆ¤',
                  onClick: () => handleAssign(record, 'judge')
                },
                {
                  key: 'assign_contestant',
                  label: 'åˆ†é…é€‰æ‰‹',
                  onClick: () => handleAssign(record, 'contestant')
                },
                {
                  key: 'assign_judge_contestant',
                  label: 'åˆ†é…è£åˆ¤-é€‰æ‰‹',
                  onClick: () => handleAssign(record, 'judge_contestant')
                },
                {
                  key: 'delete',
                  label: 'åˆ é™¤',
                  danger: true,
                  onClick: () => handleDelete(record.id)
                }
              ];
              
              return (
                <Space size="small">
                  <Button size="small" onClick={() => handleViewDetail(record)}>æŸ¥çœ‹è¯¦æƒ…</Button>
                  <Dropdown menu={{ items: menuItems }} placement="bottomRight">
                    <Button size="small">æ›´å¤š â–¼</Button>
                  </Dropdown>
                </Space>
              );
            }
            
            return <Button size="small" onClick={() => handleViewDetail(record)}>æŸ¥çœ‹è¯¦æƒ…</Button>;
          }
        }
      ];

      const getRoleUsers = () => {
        if (assignType === 'chief_judge') {
          return users.filter(u => u.role === 'chief_judge');
        } else if (assignType === 'judge') {
          return users.filter(u => u.role === 'judge');
        } else if (assignType === 'contestant') {
          return users.filter(u => u.role === 'contestant');
        }
        return users;
      };

      return (
        <div>
          {/* é¡µé¢æ ‡é¢˜ */}
          <div style={{
            marginBottom: '24px',
            padding: '20px 24px',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            borderRadius: '12px',
            color: 'white',
            boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
          }}>
            <div>
              <Title level={3} style={{ color: 'white', margin: 0 }}>
                ğŸ“‹ èµ›é¡¹ç®¡ç†
              </Title>
              <Text style={{ color: 'rgba(255,255,255,0.9)', fontSize: '14px' }}>
                ç®¡ç†èµ›äº‹çš„å…·ä½“ç«èµ›é¡¹ç›®å’Œäººå‘˜åˆ†é…
              </Text>
            </div>
            {user.role === 'admin' && (
              <Button 
                onClick={handleAdd}
                size="large"
                style={{
                  background: 'rgba(255,255,255,0.2)',
                  border: '1px solid rgba(255,255,255,0.3)',
                  color: 'white',
                  fontWeight: 500
                }}
              >
                â• æ·»åŠ èµ›é¡¹
              </Button>
            )}
          </div>

          <Table
            loading={loading}
            dataSource={events}
            columns={columns}
            rowKey="id"
          />
          <Drawer
            title={editingItem ? 'ç¼–è¾‘èµ›é¡¹' : 'æ·»åŠ èµ›é¡¹'}
            open={modalVisible}
            onClose={() => setModalVisible(false)}
            width={600}
          >
            <Form form={form} onFinish={handleSubmit} layout="vertical">
              <Form.Item label="èµ›äº‹" name="competition_id" rules={[{ required: true }]}>
                <Select>
                  {competitions.map(c => (
                    <Option key={c.id} value={c.id}>{c.name}</Option>
                  ))}
                </Select>
              </Form.Item>
              <Form.Item label="èµ›é¡¹åç§°" name="name" rules={[{ required: true }]}>
                <Input />
              </Form.Item>
              <Form.Item label="å¼€å§‹æ—¶é—´" name="start_time" rules={[{ required: true }]}>
                <DatePicker showTime style={{ width: '100%' }} />
              </Form.Item>
              <Form.Item label="ç»“æŸæ—¶é—´" name="end_time" rules={[{ required: true }]}>
                <DatePicker showTime style={{ width: '100%' }} />
              </Form.Item>
              <Form.Item>
                <Space>
                  <Button type="primary" htmlType="submit">æäº¤</Button>
                  <Button onClick={() => setModalVisible(false)}>å–æ¶ˆ</Button>
                </Space>
              </Form.Item>
            </Form>
          </Drawer>
          <Drawer
            title={`åˆ†é…${assignType === 'chief_judge' ? 'è£åˆ¤é•¿' : assignType === 'judge' ? 'è£åˆ¤' : assignType === 'contestant' ? 'é€‰æ‰‹' : 'è£åˆ¤-é€‰æ‰‹'}`}
            open={assignModalVisible}
            onClose={() => setAssignModalVisible(false)}
            width={500}
          >
            <Form form={assignForm} onFinish={handleAssignSubmit} layout="vertical">
              {assignType === 'judge_contestant' ? (
                <>
                  <Form.Item label="è£åˆ¤" name="judge_id" rules={[{ required: true }]}>
                    <Select>
                      {users.filter(u => u.role === 'judge').map(u => (
                        <Option key={u.id} value={u.id}>{u.name} ({u.username})</Option>
                      ))}
                    </Select>
                  </Form.Item>
                  <Form.Item label="é€‰æ‰‹" name="contestant_id" rules={[{ required: true }]}>
                    <Select>
                      {users.filter(u => u.role === 'contestant').map(u => (
                        <Option key={u.id} value={u.id}>{u.name} ({u.username})</Option>
                      ))}
                    </Select>
                  </Form.Item>
                </>
              ) : (
                <Form.Item label="ç”¨æˆ·" name="user_id" rules={[{ required: true }]}>
                  <Select>
                    {getRoleUsers().map(u => (
                      <Option key={u.id} value={u.id}>{u.name} ({u.username})</Option>
                    ))}
                  </Select>
                </Form.Item>
              )}
              <Form.Item>
                <Space>
                  <Button type="primary" htmlType="submit">æäº¤</Button>
                  <Button onClick={() => setAssignModalVisible(false)}>å–æ¶ˆ</Button>
                </Space>
              </Form.Item>
            </Form>
          </Drawer>
          <Drawer
            title={`èµ›é¡¹è¯¦æƒ… - ${eventDetail?.name}`}
            open={detailModalVisible}
            onClose={() => setDetailModalVisible(false)}
            width="80%"
          >
            {eventDetail && (
              <div>
                <Descriptions bordered column={2}>
                  <Descriptions.Item label="èµ›é¡¹åç§°">{eventDetail.name}</Descriptions.Item>
                  <Descriptions.Item label="èµ›äº‹">{eventDetail.competition_name}</Descriptions.Item>
                  <Descriptions.Item label="å¼€å§‹æ—¶é—´">
                    {dayjs(eventDetail.start_time).format('YYYY-MM-DD HH:mm')}
                  </Descriptions.Item>
                  <Descriptions.Item label="ç»“æŸæ—¶é—´">
                    {dayjs(eventDetail.end_time).format('YYYY-MM-DD HH:mm')}
                  </Descriptions.Item>
                </Descriptions>
                
                <Tabs defaultActiveKey="chief_judges" style={{ marginTop: 24 }}>
                  <Tabs.TabPane tab={`è£åˆ¤é•¿ (${eventDetail.chief_judges.length})`} key="chief_judges">
                    <Table
                      dataSource={eventDetail.chief_judges}
                      columns={[
                        { title: 'ID', dataIndex: 'id', key: 'id', width: 80 },
                        { title: 'ç”¨æˆ·å', dataIndex: 'username', key: 'username' },
                        { title: 'å§“å', dataIndex: 'name', key: 'name' },
                        {
                          title: 'æ“ä½œ',
                          key: 'action',
                          render: (_, record) => (
                            user.role === 'admin' ? (
                              <Button
                                size="small"
                                danger
                                onClick={() => handleRemoveAssignment('chief_judge', eventDetail.id, record.id)}
                              >
                                ç§»é™¤
                              </Button>
                            ) : null
                          )
                        }
                      ]}
                      rowKey="id"
                      pagination={false}
                      size="small"
                    />
                  </Tabs.TabPane>
                  <Tabs.TabPane tab={`è£åˆ¤ (${eventDetail.judges.length})`} key="judges">
                    <Table
                      dataSource={eventDetail.judges}
                      columns={[
                        { title: 'ID', dataIndex: 'id', key: 'id', width: 80 },
                        { title: 'ç”¨æˆ·å', dataIndex: 'username', key: 'username' },
                        { title: 'å§“å', dataIndex: 'name', key: 'name' },
                        {
                          title: 'æ“ä½œ',
                          key: 'action',
                          render: (_, record) => (
                            user.role === 'admin' ? (
                              <Button
                                size="small"
                                danger
                                onClick={() => handleRemoveAssignment('judge', eventDetail.id, record.id)}
                              >
                                ç§»é™¤
                              </Button>
                            ) : null
                          )
                        }
                      ]}
                      rowKey="id"
                      pagination={false}
                      size="small"
                    />
                  </Tabs.TabPane>
                  <Tabs.TabPane tab={`é€‰æ‰‹ (${eventDetail.contestants.length})`} key="contestants">
                    <Table
                      dataSource={eventDetail.contestants}
                      columns={[
                        { title: 'ID', dataIndex: 'id', key: 'id', width: 80 },
                        { title: 'ç”¨æˆ·å', dataIndex: 'username', key: 'username' },
                        { title: 'å§“å', dataIndex: 'name', key: 'name' },
                        {
                          title: 'æ“ä½œ',
                          key: 'action',
                          render: (_, record) => (
                            user.role === 'admin' ? (
                              <Button
                                size="small"
                                danger
                                onClick={() => handleRemoveAssignment('contestant', eventDetail.id, record.id)}
                              >
                                ç§»é™¤
                              </Button>
                            ) : null
                          )
                        }
                      ]}
                      rowKey="id"
                      pagination={false}
                      size="small"
                    />
                  </Tabs.TabPane>
                  <Tabs.TabPane tab={`æ¨¡å— (${eventDetail.modules?.length || 0})`} key="modules">
                    <Table
                      dataSource={eventDetail.modules}
                      columns={[
                        { title: 'ID', dataIndex: 'id', key: 'id', width: 80 },
                        { title: 'æ¨¡å—åç§°', dataIndex: 'name', key: 'name' },
                        { title: 'æ—¶é•¿(åˆ†é’Ÿ)', dataIndex: 'duration_minutes', key: 'duration_minutes' },
                        {
                          title: 'çŠ¶æ€',
                          dataIndex: 'status',
                          key: 'status',
                          render: (status) => {
                            const statusMap = {
                              pending: { text: 'æœªå¼€å§‹', color: 'default' },
                              in_progress: { text: 'è¿›è¡Œä¸­', color: 'processing' },
                              finished: { text: 'å·²ç»“æŸ', color: 'success' },
                              scoring: { text: 'è¯„åˆ†ä¸­', color: 'warning' },
                              scoring_finished: { text: 'è¯„åˆ†ç»“æŸ', color: 'purple' }
                            };
                            const s = statusMap[status] || { text: status, color: 'default' };
                            return <Badge status={s.color} text={s.text} />;
                          }
                        }
                      ]}
                      rowKey="id"
                      pagination={false}
                      size="small"
                    />
                  </Tabs.TabPane>
                  <Tabs.TabPane tab="è£åˆ¤-é€‰æ‰‹åˆ†é…" key="assignments">
                    <JudgeContestantAssignments eventId={eventDetail.id} user={user} />
                  </Tabs.TabPane>
                </Tabs>
              </div>
            )}
          </Drawer>
        </div>
      );
    }

    // æ¨¡å—ç®¡ç†
    function ModuleManagement({ user }) {
      const [modules, setModules] = useState([]);
      const [events, setEvents] = useState([]);
      const [loading, setLoading] = useState(false);
      const [modalVisible, setModalVisible] = useState(false);
      const [criteriaModalVisible, setCriteriaModalVisible] = useState(false);
      const [attachmentModalVisible, setAttachmentModalVisible] = useState(false);
      const [selectedModule, setSelectedModule] = useState(null);
      const [scoringCriteria, setScoringCriteria] = useState(null);
      const [problemAttachments, setProblemAttachments] = useState([]);
      const [answerAttachments, setAnswerAttachments] = useState([]);
      const [editingItem, setEditingItem] = useState(null);
      const [form] = Form.useForm();
      const [itemForm] = Form.useForm();

      const loadData = async () => {
        setLoading(true);
        try {
          const [modulesRes, eventsRes] = await Promise.all([
            axios.get('/modules'),
            axios.get('/events')
          ]);
          setModules(modulesRes.data);
          setEvents(eventsRes.data);
        } catch (error) {
          message.error('åŠ è½½æ•°æ®å¤±è´¥');
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => {
        loadData();
      }, []);

      const handleAdd = () => {
        if (!['admin', 'chief_judge'].includes(user.role)) {
          message.error('æ— æƒé™ï¼šåªæœ‰ç®¡ç†å‘˜å’Œè£åˆ¤é•¿æ‰èƒ½æ–°å»ºæ¨¡å—');
          return;
        }
        setEditingItem(null);
        form.resetFields();
        setModalVisible(true);
      };

      const handleEdit = (item) => {
        if (!['admin', 'chief_judge'].includes(user.role)) {
          message.error('æ— æƒé™ï¼šåªæœ‰ç®¡ç†å‘˜å’Œè£åˆ¤é•¿æ‰èƒ½ç¼–è¾‘æ¨¡å—');
          return;
        }
        setEditingItem(item);
        form.setFieldsValue(item);
        setModalVisible(true);
      };

      const handleDelete = async (id) => {
        if (!['admin', 'chief_judge'].includes(user.role)) {
          message.error('æ— æƒé™ï¼šåªæœ‰ç®¡ç†å‘˜å’Œè£åˆ¤é•¿æ‰èƒ½åˆ é™¤æ¨¡å—');
          return;
        }
        try {
          await axios.delete(`/modules/${id}`);
          message.success('åˆ é™¤æˆåŠŸ');
          loadData();
        } catch (error) {
          if (error.response?.status === 403) {
            message.error('æ— æƒé™ï¼šæ‚¨æ²¡æœ‰æƒé™åˆ é™¤æ­¤æ¨¡å—');
          } else {
            message.error('åˆ é™¤å¤±è´¥');
          }
        }
      };

      const handleSubmit = async (values) => {
        try {
          if (editingItem) {
            await axios.put(`/modules/${editingItem.id}`, values);
            message.success('æ›´æ–°æˆåŠŸ');
          } else {
            await axios.post('/modules', values);
            message.success('åˆ›å»ºæˆåŠŸ');
          }
          setModalVisible(false);
          loadData();
        } catch (error) {
          message.error('æ“ä½œå¤±è´¥');
        }
      };

      const handleStatusChange = async (id, status) => {
        try {
          await axios.patch(`/modules/${id}/status`, { status });
          message.success('çŠ¶æ€æ›´æ–°æˆåŠŸ');
          loadData();
        } catch (error) {
          message.error('çŠ¶æ€æ›´æ–°å¤±è´¥');
        }
      };

      const handleManageCriteria = async (module) => {
        setSelectedModule(module);
        try {
          const response = await axios.get(`/scoring/modules/${module.id}/criteria`);
          setScoringCriteria(response.data);
          setCriteriaModalVisible(true);
        } catch (error) {
          message.error('åŠ è½½è¯„åˆ†æ ‡å‡†å¤±è´¥');
        }
      };

      const handleManageAttachments = (module) => {
        // é€‰æ‰‹åœ¨æ¨¡å—æœªå¼€å§‹æ—¶æ— æ³•æŸ¥çœ‹
        if (user.role === 'contestant' && module.status === 'pending') {
          message.error('æ¨¡å—å°šæœªå¼€å§‹ï¼Œæ— æ³•æŸ¥çœ‹èµ›é¢˜');
          return;
        }
        
        setSelectedModule(module);
        setAttachmentModalVisible(true);
        loadProblemAttachments(module.id);
        if (user.role === 'contestant') {
          loadAnswerAttachments(module.id, user.id);
        }
      };

      const handleCreateCriteria = async () => {
        try {
          const response = await axios.post(`/scoring/modules/${selectedModule.id}/criteria`);
          setScoringCriteria(response.data);
          message.success('åˆ›å»ºæˆåŠŸ');
        } catch (error) {
          message.error('åˆ›å»ºå¤±è´¥');
        }
      };

      const handleAddItem = async (values) => {
        try {
          await axios.post(`/scoring/criteria/${scoringCriteria.id}/items`, values);
          message.success('æ·»åŠ æˆåŠŸ');
          itemForm.resetFields();
          handleManageCriteria(selectedModule);
        } catch (error) {
          message.error('æ·»åŠ å¤±è´¥');
        }
      };

      const handleDeleteItem = async (itemId) => {
        try {
          await axios.delete(`/scoring/items/${itemId}`);
          message.success('åˆ é™¤æˆåŠŸ');
          handleManageCriteria(selectedModule);
        } catch (error) {
          message.error('åˆ é™¤å¤±è´¥');
        }
      };

      const loadProblemAttachments = async (moduleId) => {
        try {
          const response = await axios.get(`/attachments/modules/${moduleId}/problem`);
          setProblemAttachments(response.data);
        } catch (error) {
          console.error('åŠ è½½èµ›é¢˜é™„ä»¶å¤±è´¥:', error);
          setProblemAttachments([]);
        }
      };

      const loadAnswerAttachments = async (moduleId, contestantId) => {
        try {
          const response = await axios.get(`/attachments/modules/${moduleId}/contestants/${contestantId}/answer`);
          setAnswerAttachments(response.data);
        } catch (error) {
          console.error('åŠ è½½ç­”é¢˜é™„ä»¶å¤±è´¥:', error);
          setAnswerAttachments([]);
        }
      };

      const handleUploadProblem = async (info) => {
        if (info.file.status === 'done') {
          message.success('èµ›é¢˜ä¸Šä¼ æˆåŠŸ');
          loadProblemAttachments(selectedModule.id);
        } else if (info.file.status === 'error') {
          message.error('èµ›é¢˜ä¸Šä¼ å¤±è´¥');
        }
      };

      const handleUploadAnswer = async (info) => {
        if (info.file.status === 'done') {
          message.success('ç­”é¢˜ä¸Šä¼ æˆåŠŸ');
          loadAnswerAttachments(selectedModule.id, user.id);
        } else if (info.file.status === 'error') {
          message.error('ç­”é¢˜ä¸Šä¼ å¤±è´¥');
        }
      };

      const handleDeleteProblem = async (id) => {
        try {
          await axios.delete(`/attachments/problem/${id}`);
          message.success('åˆ é™¤æˆåŠŸ');
          loadProblemAttachments(selectedModule.id);
        } catch (error) {
          message.error('åˆ é™¤å¤±è´¥');
        }
      };

      const handleDeleteAnswer = async (id) => {
        try {
          await axios.delete(`/attachments/answer/${id}`);
          message.success('åˆ é™¤æˆåŠŸ');
          loadAnswerAttachments(selectedModule.id, user.id);
        } catch (error) {
          message.error('åˆ é™¤å¤±è´¥');
        }
      };

      const handleDownload = (filepath, filename) => {
        window.open(`/api/attachments/download?filepath=${encodeURIComponent(filepath)}`);
      };

      // AIè¯„åˆ†å¤„ç†å‡½æ•°
      const handleModuleAiEvaluation = (moduleId) => {
        Modal.confirm({
          title: 'ç¡®è®¤å¯åŠ¨AIè¯„åˆ†',
          content: (
            <div>
              <p>âš ï¸ AIè¯„åˆ†éœ€è¦å¤„ç†è¾ƒé•¿æ—¶é—´ï¼Œè¯·å‹¿é‡å¤æ“ä½œã€‚</p>
              <p>ç¡®å®šè¦å¯¹æ­¤æ¨¡å—çš„æ‰€æœ‰é€‰æ‰‹å¯åŠ¨AIè¯„åˆ†å—ï¼Ÿ</p>
            </div>
          ),
          okText: 'ç¡®è®¤å¯åŠ¨',
          cancelText: 'å–æ¶ˆ',
          onOk: async () => {
            try {
              await axios.post(`/modules/${moduleId}/ai-evaluation`);
              message.success('AIè¯„åˆ†å·²å¯åŠ¨ï¼Œè¯·è€å¿ƒç­‰å¾…');
            } catch (error) {
              if (error.response?.status === 409) {
                message.warning('AIè¯„åˆ†æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·å‹¿é‡å¤æ“ä½œ');
              } else {
                message.error('å¯åŠ¨AIè¯„åˆ†å¤±è´¥ï¼š' + (error.response?.data?.error || 'æœªçŸ¥é”™è¯¯'));
              }
            }
          }
        });
      };

      const columns = [
        { title: 'ID', dataIndex: 'id', key: 'id', width: 60 },
        { title: 'æ¨¡å—åç§°', dataIndex: 'name', key: 'name' },
        {
          title: 'èµ›é¡¹',
          dataIndex: 'event_id',
          key: 'event_id',
          render: (id) => events.find(e => e.id === id)?.name || '-'
        },
        {
          title: 'æ—¶é•¿(åˆ†é’Ÿ)',
          dataIndex: 'duration_minutes',
          key: 'duration_minutes',
          width: 110
        },
        {
          title: 'çŠ¶æ€',
          dataIndex: 'status',
          key: 'status',
          width: 100,
          render: (status) => {
            const statusMap = {
              pending: { text: 'æœªå¼€å§‹', color: 'default' },
              in_progress: { text: 'è¿›è¡Œä¸­', color: 'processing' },
              finished: { text: 'å·²ç»“æŸ', color: 'success' },
              scoring: { text: 'è¯„åˆ†ä¸­', color: 'warning' },
              scoring_finished: { text: 'è¯„åˆ†ç»“æŸ', color: 'purple' }
            };
            const s = statusMap[status] || { text: status, color: 'default' };
            return <Badge status={s.color} text={s.text} />;
          }
        },
        {
          title: 'æ“ä½œ',
          key: 'action',
          width: 500,
          render: (_, record) => {
            const { Dropdown } = antd;
            
            if (['admin', 'chief_judge'].includes(user.role)) {
              const menuItems = [
                {
                  key: 'edit',
                  label: 'ç¼–è¾‘',
                  onClick: () => handleEdit(record)
                },
                {
                  key: 'ai',
                  label: 'AIè¯„åˆ†',
                  onClick: () => handleModuleAiEvaluation(record.id),
                  disabled: !['scoring', 'finished'].includes(record.status)
                },
                {
                  key: 'delete',
                  label: 'åˆ é™¤',
                  danger: true,
                  onClick: () => handleDelete(record.id)
                }
              ];
              
              return (
                <Space size="small">
                  <Select
                    size="small"
                    value={record.status}
                    onChange={(val) => handleStatusChange(record.id, val)}
                    style={{ width: 95 }}
                  >
                    <Option value="pending">æœªå¼€å§‹</Option>
                    <Option value="in_progress">è¿›è¡Œä¸­</Option>
                    <Option value="finished">å·²ç»“æŸ</Option>
                    <Option value="scoring">è¯„åˆ†ä¸­</Option>
                    <Option value="scoring_finished">è¯„åˆ†ç»“æŸ</Option>
                  </Select>
                  <Button size="small" onClick={() => handleManageCriteria(record)}>è¯„åˆ†æ ‡å‡†</Button>
                  <Button size="small" onClick={() => handleManageAttachments(record)}>èµ›é¢˜</Button>
                  <Dropdown menu={{ items: menuItems }} placement="bottomRight">
                    <Button size="small">æ›´å¤š â–¼</Button>
                  </Dropdown>
                </Space>
              );
            }
            
            return (
              <Button 
                size="small" 
                onClick={() => handleManageAttachments(record)}
                disabled={user.role === 'contestant' && record.status === 'pending'}
              >
                æŸ¥çœ‹èµ›é¢˜/ç­”é¢˜
              </Button>
            );
          }
        }
      ];

      return (
        <div>
          {/* é¡µé¢æ ‡é¢˜ */}
          <div style={{
            marginBottom: '24px',
            padding: '20px 24px',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            borderRadius: '12px',
            color: 'white',
            boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
          }}>
            <div>
              <Title level={3} style={{ color: 'white', margin: 0 }}>
                ğŸ“¦ æ¨¡å—ç®¡ç†
              </Title>
              <Text style={{ color: 'rgba(255,255,255,0.9)', fontSize: '14px' }}>
                ç®¡ç†èµ›é¡¹çš„è€ƒæ ¸æ¨¡å—ã€è¯„åˆ†æ ‡å‡†å’Œèµ›é¢˜èµ„æ–™
              </Text>
            </div>
            {['admin', 'chief_judge'].includes(user.role) && (
              <Button 
                onClick={handleAdd}
                size="large"
                style={{
                  background: 'rgba(255,255,255,0.2)',
                  border: '1px solid rgba(255,255,255,0.3)',
                  color: 'white',
                  fontWeight: 500
                }}
              >
                â• æ·»åŠ æ¨¡å—
              </Button>
            )}
          </div>

          <Table
            loading={loading}
            dataSource={modules}
            columns={columns}
            rowKey="id"
          />
          <Drawer
            title={editingItem ? 'ç¼–è¾‘æ¨¡å—' : 'æ·»åŠ æ¨¡å—'}
            open={modalVisible}
            onClose={() => setModalVisible(false)}
            width={600}
          >
            <Form form={form} onFinish={handleSubmit} layout="vertical">
              <Form.Item label="èµ›é¡¹" name="event_id" rules={[{ required: true }]}>
                <Select>
                  {events.map(e => (
                    <Option key={e.id} value={e.id}>{e.name}</Option>
                  ))}
                </Select>
              </Form.Item>
              <Form.Item label="æ¨¡å—åç§°" name="name" rules={[{ required: true }]}>
                <Input />
              </Form.Item>
              <Form.Item label="æ—¶é•¿(åˆ†é’Ÿ)" name="duration_minutes" rules={[{ required: true }]}>
                <InputNumber min={1} style={{ width: '100%' }} />
              </Form.Item>
              <Form.Item>
                <Space>
                  <Button type="primary" htmlType="submit">æäº¤</Button>
                  <Button onClick={() => setModalVisible(false)}>å–æ¶ˆ</Button>
                </Space>
              </Form.Item>
            </Form>
          </Drawer>
          <Drawer
            title={`è¯„åˆ†æ ‡å‡†ç®¡ç† - ${selectedModule?.name}`}
            open={criteriaModalVisible}
            onClose={() => setCriteriaModalVisible(false)}
            width="80%"
          >
            {!scoringCriteria ? (
              <div style={{ textAlign: 'center', padding: 40 }}>
                <p>å°šæœªåˆ›å»ºè¯„åˆ†æ ‡å‡†</p>
                <Button type="primary" onClick={handleCreateCriteria}>åˆ›å»ºè¯„åˆ†æ ‡å‡†</Button>
              </div>
            ) : (
              <div>
                <Title level={5}>è¯„åˆ†é¡¹åˆ—è¡¨</Title>
                <Table
                  dataSource={scoringCriteria.items.filter(item => item.id)}
                  columns={[
                    { title: 'ID', dataIndex: 'id', key: 'id', width: 60 },
                    {
                      title: 'æè¿°',
                      dataIndex: 'description',
                      key: 'description',
                      ellipsis: true
                    },
                    {
                      title: 'ç±»å‹',
                      dataIndex: 'evaluation_type',
                      key: 'evaluation_type',
                      render: (type) => type === 'objective' ? 'å®¢è§‚' : 'ä¸»è§‚'
                    },
                    {
                      title: 'æ»¡åˆ†',
                      dataIndex: 'max_score',
                      key: 'max_score'
                    },
                    {
                      title: 'æ“ä½œ',
                      key: 'action',
                      render: (_, record) => (
                        <Button size="small" danger onClick={() => handleDeleteItem(record.id)}>
                          åˆ é™¤
                        </Button>
                      )
                    }
                  ]}
                  rowKey="id"
                  pagination={false}
                  size="small"
                />
                <Divider />
                <Title level={5}>æ·»åŠ è¯„åˆ†é¡¹</Title>
                <Form form={itemForm} onFinish={handleAddItem} layout="vertical">
                  <Form.Item
                    label="è¯„åˆ†æ ‡å‡†æè¿°ï¼ˆæ”¯æŒå¯Œæ–‡æœ¬/HTMLï¼‰"
                    name="description"
                    rules={[{ required: true }]}
                  >
                    <TextArea rows={3} />
                  </Form.Item>
                  <Form.Item label="è¯„ä¼°ç±»å‹" name="evaluation_type" rules={[{ required: true }]}>
                    <Select>
                      <Option value="objective">å®¢è§‚</Option>
                      <Option value="subjective">ä¸»è§‚</Option>
                    </Select>
                  </Form.Item>
                  <Form.Item label="æ»¡åˆ†" name="max_score" rules={[{ required: true }]}>
                    <InputNumber min={0} step={0.01} style={{ width: '100%' }} />
                  </Form.Item>
                  <Form.Item label="æ’åº" name="sort_order">
                    <InputNumber min={0} style={{ width: '100%' }} />
                  </Form.Item>
                  <Form.Item>
                    <Button type="primary" htmlType="submit">æ·»åŠ è¯„åˆ†é¡¹</Button>
                  </Form.Item>
                </Form>
              </div>
            )}
          </Drawer>
          <Drawer
            title={`é™„ä»¶ç®¡ç† - ${selectedModule?.name}`}
            open={attachmentModalVisible}
            onClose={() => setAttachmentModalVisible(false)}
            width="80%"
          >
            <Tabs defaultActiveKey="problem">
              <Tabs.TabPane tab="èµ›é¢˜é™„ä»¶" key="problem">
                {['admin', 'chief_judge'].includes(user.role) && (
                  <div style={{ marginBottom: 16 }}>
                    <Upload
                      name="file"
                      action={`/api/attachments/modules/${selectedModule?.id}/problem`}
                      headers={{
                        Authorization: axios.defaults.headers.common['Authorization']
                      }}
                      onChange={handleUploadProblem}
                    >
                      <Button>ä¸Šä¼ èµ›é¢˜</Button>
                    </Upload>
                  </div>
                )}
                <Table
                  dataSource={problemAttachments}
                  columns={[
                    { title: 'æ–‡ä»¶å', dataIndex: 'filename', key: 'filename' },
                    {
                      title: 'ä¸Šä¼ æ—¶é—´',
                      dataIndex: 'created_at',
                      key: 'created_at',
                      render: (val) => dayjs(val).format('YYYY-MM-DD HH:mm')
                    },
                    {
                      title: 'æ“ä½œ',
                      key: 'action',
                      render: (_, record) => (
                        <Space>
                          <Button
                            size="small"
                            onClick={() => handleDownload(record.filepath, record.filename)}
                          >
                            ä¸‹è½½
                          </Button>
                          {['admin', 'chief_judge'].includes(user.role) && (
                            <Popconfirm
                              title="ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèµ›é¢˜æ–‡ä»¶å—ï¼Ÿ"
                              onConfirm={() => handleDeleteProblem(record.id)}
                            >
                              <Button size="small" danger>åˆ é™¤</Button>
                            </Popconfirm>
                          )}
                        </Space>
                      )
                    }
                  ]}
                  rowKey="id"
                  pagination={false}
                />
              </Tabs.TabPane>
              {user.role === 'contestant' && (
                <Tabs.TabPane tab="æˆ‘çš„ç­”é¢˜" key="answer">
                  {selectedModule?.status === 'in_progress' && (
                    <div style={{ marginBottom: 16 }}>
                      <Upload
                        name="file"
                        action={`/api/attachments/modules/${selectedModule?.id}/answer`}
                        headers={{
                          Authorization: axios.defaults.headers.common['Authorization']
                        }}
                        onChange={handleUploadAnswer}
                      >
                        <Button>ä¸Šä¼ ç­”é¢˜</Button>
                      </Upload>
                    </div>
                  )}
                  <Table
                    dataSource={answerAttachments}
                    columns={[
                      { title: 'æ–‡ä»¶å', dataIndex: 'filename', key: 'filename' },
                      {
                        title: 'ä¸Šä¼ æ—¶é—´',
                        dataIndex: 'created_at',
                        key: 'created_at',
                        render: (val) => dayjs(val).format('YYYY-MM-DD HH:mm')
                      },
                      {
                        title: 'æ“ä½œ',
                        key: 'action',
                        render: (_, record) => (
                          <Space>
                            <Button
                              size="small"
                              onClick={() => handleDownload(record.filepath, record.filename)}
                            >
                              ä¸‹è½½
                            </Button>
                            {selectedModule?.status === 'in_progress' && (
                              <Popconfirm
                                title="ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç­”é¢˜æ–‡ä»¶å—ï¼Ÿ"
                                onConfirm={() => handleDeleteAnswer(record.id)}
                              >
                                <Button size="small" danger>åˆ é™¤</Button>
                              </Popconfirm>
                            )}
                          </Space>
                        )
                      }
                    ]}
                    rowKey="id"
                    pagination={false}
                  />
                </Tabs.TabPane>
              )}
              {user.role === 'judge' && (
                <Tabs.TabPane tab="é€‰æ‰‹ç­”é¢˜" key="contestant_answers">
                  <ContestantAnswers moduleId={selectedModule?.id} user={user} />
                </Tabs.TabPane>
              )}
            </Tabs>
          </Drawer>
        </div>
      );
    }

    // è£åˆ¤æŸ¥çœ‹é€‰æ‰‹ç­”é¢˜ç»„ä»¶
    function ContestantAnswers({ moduleId, user }) {
      const [contestants, setContestants] = useState([]);
      const [selectedContestant, setSelectedContestant] = useState(null);
      const [answerAttachments, setAnswerAttachments] = useState([]);
      const [loading, setLoading] = useState(false);

      const loadMyContestants = async () => {
        try {
          const response = await axios.get(`/scoring/modules/${moduleId}/records`);
          setContestants(response.data);
        } catch (error) {
          console.error('åŠ è½½é€‰æ‰‹åˆ—è¡¨å¤±è´¥:', error);
        }
      };

      const loadContestantAnswers = async (contestantId) => {
        setLoading(true);
        try {
          const response = await axios.get(`/attachments/modules/${moduleId}/contestants/${contestantId}/answer`);
          setAnswerAttachments(response.data);
        } catch (error) {
          console.error('åŠ è½½é€‰æ‰‹ç­”é¢˜å¤±è´¥:', error);
          setAnswerAttachments([]);
        } finally {
          setLoading(false);
        }
      };

      const handleDownload = (filepath, filename) => {
        window.open(`/api/attachments/download?filepath=${encodeURIComponent(filepath)}`);
      };

      useEffect(() => {
        if (moduleId) {
          loadMyContestants();
        }
      }, [moduleId]);

      useEffect(() => {
        if (selectedContestant) {
          loadContestantAnswers(selectedContestant);
        }
      }, [selectedContestant]);

      return (
        <div>
          <div style={{ marginBottom: 16 }}>
            <Select
              placeholder="é€‰æ‹©è¦æŸ¥çœ‹çš„é€‰æ‰‹"
              style={{ width: 300 }}
              onChange={setSelectedContestant}
              value={selectedContestant}
            >
              {contestants.map(c => (
                <Option key={c.contestant_id} value={c.contestant_id}>
                  {c.contestant_name} ({c.username})
                </Option>
              ))}
            </Select>
          </div>
          {selectedContestant && (
            <Table
              loading={loading}
              dataSource={answerAttachments}
              columns={[
                { title: 'æ–‡ä»¶å', dataIndex: 'filename', key: 'filename' },
                {
                  title: 'ä¸Šä¼ æ—¶é—´',
                  dataIndex: 'created_at',
                  key: 'created_at',
                  render: (val) => dayjs(val).format('YYYY-MM-DD HH:mm')
                },
                {
                  title: 'æ“ä½œ',
                  key: 'action',
                  render: (_, record) => (
                    <Button
                      size="small"
                      onClick={() => handleDownload(record.filepath, record.filename)}
                    >
                      ä¸‹è½½æŸ¥çœ‹
                    </Button>
                  )
                }
              ]}
              rowKey="id"
              pagination={false}
            />
          )}
        </div>
      );
    }

    // è£åˆ¤-é€‰æ‰‹åˆ†é…å…³ç³»ç»„ä»¶
    function JudgeContestantAssignments({ eventId, user }) {
      const [assignments, setAssignments] = useState([]);
      const [loading, setLoading] = useState(false);

      const loadAssignments = async () => {
        setLoading(true);
        try {
          const response = await axios.get(`/events/${eventId}/judge-contestants`);
          setAssignments(response.data);
        } catch (error) {
          console.error('åŠ è½½åˆ†é…å…³ç³»å¤±è´¥:', error);
          setAssignments([]);
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => {
        if (eventId) {
          loadAssignments();
        }
      }, [eventId]);

      const handleRemoveAssignment = async (judgeId, contestantId) => {
        try {
          await axios.delete(`/events/${eventId}/judge-contestants?judge_id=${judgeId}&contestant_id=${contestantId}`);
          message.success('ç§»é™¤æˆåŠŸ');
          loadAssignments();
        } catch (error) {
          message.error('ç§»é™¤å¤±è´¥');
        }
      };

      const columns = [
        { title: 'è£åˆ¤ID', dataIndex: 'judge_id', key: 'judge_id', width: 80 },
        { title: 'è£åˆ¤å§“å', dataIndex: 'judge_name', key: 'judge_name' },
        { title: 'é€‰æ‰‹ID', dataIndex: 'contestant_id', key: 'contestant_id', width: 80 },
        { title: 'é€‰æ‰‹å§“å', dataIndex: 'contestant_name', key: 'contestant_name' },
        {
          title: 'æ“ä½œ',
          key: 'action',
          render: (_, record) => (
            user.role === 'admin' ? (
              <Button
                size="small"
                danger
                onClick={() => handleRemoveAssignment(record.judge_id, record.contestant_id)}
              >
                ç§»é™¤åˆ†é…
              </Button>
            ) : null
          )
        }
      ];

      return (
        <Table
          loading={loading}
          dataSource={assignments}
          columns={columns}
          rowKey={(record) => `${record.judge_id}-${record.contestant_id}`}
          pagination={false}
          size="small"
        />
      );
    }

    // è¯„åˆ†ç®¡ç†
    function ScoringManagement({ user }) {
      const [modules, setModules] = useState([]);
      const [expandedRows, setExpandedRows] = useState([]);
      const [contestantsData, setContestantsData] = useState({});
      const [loading, setLoading] = useState(false);
      const [drawerVisible, setDrawerVisible] = useState(false);
      const [selectedContestant, setSelectedContestant] = useState(null);
      const [selectedModule, setSelectedModule] = useState(null);

      const loadModules = async () => {
        setLoading(true);
        try {
          const response = await axios.get('/modules');
          let filteredModules = response.data;
          
          // è£åˆ¤åªèƒ½çœ‹åˆ°è¯„åˆ†ä¸­å’Œè¯„åˆ†ç»“æŸçš„æ¨¡å—
          if (user.role === 'judge') {
            filteredModules = response.data.filter(module => 
              module.status === 'scoring' || module.status === 'scoring_finished'
            );
          }
          
          setModules(filteredModules);
        } catch (error) {
          message.error('åŠ è½½æ¨¡å—å¤±è´¥');
        } finally {
          setLoading(false);
        }
      };

      const loadContestants = async (moduleId) => {
        try {
          const [recordsResponse] = await Promise.all([
            axios.get(`/scoring/modules/${moduleId}/records`)
          ]);
          
          const contestants = recordsResponse.data || [];
          
          // ä¸ºæ¯ä¸ªé€‰æ‰‹åŠ è½½ç­”é¢˜é™„ä»¶
          const contestantsWithAttachments = await Promise.all(
            contestants.map(async (contestant) => {
              try {
                const attachmentResponse = await axios.get(
                  `/attachments/modules/${moduleId}/contestants/${contestant.contestant_id}/answer`
                );
                return {
                  ...contestant,
                  answerAttachments: attachmentResponse.data || []
                };
              } catch (error) {
                return {
                  ...contestant,
                  answerAttachments: []
                };
              }
            })
          );

          setContestantsData(prev => ({
            ...prev,
            [moduleId]: contestantsWithAttachments
          }));
        } catch (error) {
          message.error('åŠ è½½é€‰æ‰‹æ•°æ®å¤±è´¥');
          setContestantsData(prev => ({
            ...prev,
            [moduleId]: []
          }));
        }
      };

      useEffect(() => {
        loadModules();
      }, []);

      const handleExpand = (expanded, record) => {
        if (expanded) {
          setExpandedRows([...expandedRows, record.id]);
          loadContestants(record.id);
        } else {
          setExpandedRows(expandedRows.filter(id => id !== record.id));
        }
      };

      const handleUpdateScore = async (moduleId, contestantId, itemId, score) => {
        try {
          // ç«‹å³æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼Œæä¾›å³æ—¶åé¦ˆ
          if (selectedContestant && selectedContestant.contestant_id === contestantId) {
            const updatedItemResults = selectedContestant.item_results.map(item => {
              if ((item.scoring_item_id || item.id) === itemId) {
                return { ...item, judge_score: score };
              }
              return item;
            });
            setSelectedContestant({
              ...selectedContestant,
              item_results: updatedItemResults
            });
          }

          // åŒæ—¶æ›´æ–°ä¸»åˆ—è¡¨ä¸­çš„æ•°æ®
          setContestantsData(prev => {
            const moduleContestants = prev[moduleId] || [];
            const updatedContestants = moduleContestants.map(contestant => {
              if (contestant.contestant_id === contestantId) {
                const updatedItemResults = contestant.item_results.map(item => {
                  if ((item.scoring_item_id || item.id) === itemId) {
                    return { ...item, judge_score: score };
                  }
                  return item;
                });
                return {
                  ...contestant,
                  item_results: updatedItemResults
                };
              }
              return contestant;
            });
            return {
              ...prev,
              [moduleId]: updatedContestants
            };
          });

          // åå°ä¿å­˜åˆ°æœåŠ¡å™¨
          await axios.put(
            `/scoring/modules/${moduleId}/contestants/${contestantId}/score`,
            {
              scoring_item_id: itemId,
              judge_score: score
            }
          );
          
        } catch (error) {
          message.error('è¯„åˆ†ä¿å­˜å¤±è´¥ï¼š' + (error.response?.data?.error || 'ç½‘ç»œé”™è¯¯'));
          // å¦‚æœä¿å­˜å¤±è´¥ï¼Œå¯ä»¥è€ƒè™‘æ¢å¤ä¹‹å‰çš„çŠ¶æ€
          console.error('è¯„åˆ†ä¿å­˜å¤±è´¥:', error);
        }
      };

      const handleEditScoring = (contestant, module) => {
        setSelectedContestant(contestant);
        setSelectedModule(module);
        setDrawerVisible(true);
      };

      const handleCreateScoringRecord = async () => {
        try {
          const response = await axios.post(`/scoring/modules/${selectedModule.id}/contestants/${selectedContestant.contestant_id}/create-record`);
          message.success('åˆ›å»ºè¯„åˆ†è®°å½•æˆåŠŸ');
          
          // å¼ºåˆ¶é‡æ–°åŠ è½½æ•°æ®
          const refreshData = async () => {
            try {
              // é‡æ–°è·å–é€‰æ‰‹çš„è¯¦ç»†æ•°æ®
              const recordsResponse = await axios.get(`/scoring/modules/${selectedModule.id}/records`);
              const contestants = recordsResponse.data || [];
              
              // ä¸ºæ¯ä¸ªé€‰æ‰‹åŠ è½½ç­”é¢˜é™„ä»¶ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
              const contestantsWithAttachments = await Promise.all(
                contestants.map(async (contestant) => {
                  try {
                    const attachmentResponse = await axios.get(
                      `/attachments/modules/${selectedModule.id}/contestants/${contestant.contestant_id}/answer`
                    );
                    return {
                      ...contestant,
                      answerAttachments: attachmentResponse.data || []
                    };
                  } catch (error) {
                    return {
                      ...contestant,
                      answerAttachments: []
                    };
                  }
                })
              );

              // æ›´æ–°ä¸»åˆ—è¡¨æ•°æ®
              setContestantsData(prev => ({
                ...prev,
                [selectedModule.id]: contestantsWithAttachments
              }));

              // æ‰¾åˆ°å¹¶æ›´æ–°å½“å‰é€‰æ‰‹æ•°æ®
              const updatedContestant = contestantsWithAttachments.find(c => c.contestant_id === selectedContestant.contestant_id);
              if (updatedContestant) {
                console.log('æ›´æ–°é€‰æ‰‹æ•°æ®:', updatedContestant);
                setSelectedContestant(updatedContestant);
              }
            } catch (refreshError) {
              console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', refreshError);
              message.error('åˆ·æ–°æ•°æ®å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å…³é—­å¹¶é‡æ–°æ‰“å¼€è¯„åˆ†ç•Œé¢');
            }
          };

          // å»¶è¿Ÿåˆ·æ–°ç¡®ä¿åç«¯æ•°æ®å·²æ›´æ–°
          setTimeout(refreshData, 800);
          
        } catch (error) {
          console.error('åˆ›å»ºè¯„åˆ†è®°å½•å¤±è´¥:', error);
          message.error('åˆ›å»ºè¯„åˆ†è®°å½•å¤±è´¥ï¼š' + (error.response?.data?.error || 'æœªçŸ¥é”™è¯¯'));
        }
      };

      // å•ä¸ªé€‰æ‰‹AIè¯„åˆ†å¤„ç†å‡½æ•°
      const handleContestantAiEvaluation = (moduleId, contestantId) => {
        Modal.confirm({
          title: 'ç¡®è®¤å¯åŠ¨AIè¯„åˆ†',
          content: (
            <div>
              <p>âš ï¸ AIè¯„åˆ†éœ€è¦å¤„ç†è¾ƒé•¿æ—¶é—´ï¼Œè¯·å‹¿é‡å¤æ“ä½œã€‚</p>
              <p>ç¡®å®šè¦å¯¹æ­¤é€‰æ‰‹å¯åŠ¨AIè¯„åˆ†å—ï¼Ÿ</p>
            </div>
          ),
          okText: 'ç¡®è®¤å¯åŠ¨',
          cancelText: 'å–æ¶ˆ',
          onOk: async () => {
            try {
              await axios.post(`/modules/${moduleId}/contestants/${contestantId}/ai-evaluation`);
              message.success('AIè¯„åˆ†å·²å¯åŠ¨ï¼Œè¯·è€å¿ƒç­‰å¾…');
            } catch (error) {
              if (error.response?.status === 409) {
                message.warning('AIè¯„åˆ†æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·å‹¿é‡å¤æ“ä½œ');
              } else {
                message.error('å¯åŠ¨AIè¯„åˆ†å¤±è´¥ï¼š' + (error.response?.data?.error || 'æœªçŸ¥é”™è¯¯'));
              }
            }
          }
        });
      };

      const statusConfig = {
        pending: { text: 'æœªå¼€å§‹', color: 'default' },
        in_progress: { text: 'è¿›è¡Œä¸­', color: 'processing' },
        finished: { text: 'å·²ç»“æŸ', color: 'success' },
        scoring: { text: 'è¯„åˆ†ä¸­', color: 'warning' },
        scoring_finished: { text: 'è¯„åˆ†ç»“æŸ', color: 'purple' }
      };

      const moduleColumns = [
        { title: 'æ¨¡å—åç§°', dataIndex: 'name', key: 'name' },
        { 
          title: 'çŠ¶æ€', 
          dataIndex: 'status', 
          key: 'status',
          render: (status) => (
            <Tag color={statusConfig[status]?.color}>{statusConfig[status]?.text}</Tag>
          )
        },
        { title: 'æ—¶é•¿(åˆ†é’Ÿ)', dataIndex: 'duration_minutes', key: 'duration_minutes' },
        {
          title: 'é€‰æ‰‹æ•°é‡',
          key: 'contestant_count',
          render: (_, record) => (
            contestantsData[record.id] ? contestantsData[record.id].length : '-'
          )
        }
      ];

      const expandedRowRender = (moduleRecord) => {
        const contestants = contestantsData[moduleRecord.id] || [];
        
        if (contestants.length === 0) {
          return <div style={{ padding: 16, textAlign: 'center' }}>æ²¡æœ‰é€‰æ‰‹æ•°æ®</div>;
        }

        const contestantColumns = [
          { title: 'é€‰æ‰‹', dataIndex: 'contestant_name', key: 'contestant_name', width: 120 },
          { title: 'ç”¨æˆ·å', dataIndex: 'username', key: 'username', width: 100 },
          {
            title: 'ç­”é¢˜æ–‡ä»¶',
            key: 'attachments',
            width: 200,
            ellipsis: {
              showTitle: false,
            },
            render: (_, record) => {
              const filenames = record.answerAttachments?.map(a => a.filename).join(', ') || 'æœªä¸Šä¼ ';
              return (
                <span 
                  title={filenames}
                  style={{ cursor: record.answerAttachments?.length ? 'pointer' : 'default' }}
                  onClick={() => {
                    if (record.answerAttachments?.length > 0) {
                      window.open(`/attachments/download?filepath=${encodeURIComponent(record.answerAttachments[0].filepath)}`, '_blank');
                    }
                  }}
                >
                  {filenames}
                </span>
              );
            }
          },
          {
            title: 'AIè¯„åˆ†',
            key: 'ai_score',
            width: 90,
            render: (_, record) => {
              const items = record.item_results.filter(item => item.id || item.scoring_item_id);
              const aiTotal = items.reduce((sum, item) => sum + (parseFloat(item.ai_score) || 0), 0);
              return <Text strong style={{ color: '#52c41a' }}>{aiTotal.toFixed(1)}</Text>;
            }
          },
          {
            title: 'è£åˆ¤è¯„åˆ†',
            key: 'judge_score',
            width: 90,
            render: (_, record) => {
              const items = record.item_results.filter(item => item.id || item.scoring_item_id);
              const judgeTotal = items.reduce((sum, item) => sum + (parseFloat(item.judge_score) || 0), 0);
              return <Text strong style={{ color: '#1890ff' }}>{judgeTotal.toFixed(1)}</Text>;
            }
          },
          {
            title: 'æ“ä½œ',
            key: 'action',
            width: ['admin', 'chief_judge'].includes(user.role) ? 180 : 100,
            render: (_, record) => (
              <Space>
                <Button
                  type="primary"
                  size="small"
                  onClick={() => handleEditScoring(record, moduleRecord)}
                  disabled={moduleRecord.status === 'scoring_finished'}
                >
                  è£åˆ¤è¯„åˆ†
                </Button>
                {['admin', 'chief_judge'].includes(user.role) && (
                  <Button
                    size="small"
                    onClick={() => handleContestantAiEvaluation(moduleRecord.id, record.contestant_id)}
                    disabled={moduleRecord.status !== 'scoring'}
                  >
                    AIè¯„åˆ†
                  </Button>
                )}
              </Space>
            )
          }
        ];

        return (
          <Table
            columns={contestantColumns}
            dataSource={contestants}
            pagination={false}
            size="small"
            scroll={{ x: 900 }}
            rowKey="id"
          />
        );
      };

      return (
        <div>
          {/* é¡µé¢æ ‡é¢˜ */}
          <div style={{
            marginBottom: '24px',
            padding: '20px 24px',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            borderRadius: '12px',
            color: 'white',
            boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
          }}>
            <Title level={3} style={{ color: 'white', margin: 0 }}>
              âœï¸ è¯„åˆ†ç®¡ç†
            </Title>
            <Text style={{ color: 'rgba(255,255,255,0.9)', fontSize: '14px' }}>
              æŸ¥çœ‹é€‰æ‰‹ç­”é¢˜å¹¶è¿›è¡Œäººå·¥è¯„åˆ†å’ŒAIè¾…åŠ©è¯„åˆ†
            </Text>
          </div>

          <div style={{ 
            marginBottom: 16,
            padding: '16px',
            background: '#e8f4fd',
            borderRadius: '8px',
            border: '1px solid #91d5ff'
          }}>
            <Text strong style={{ color: '#0958d9' }}>ğŸ’¡ ä½¿ç”¨æç¤ºï¼š</Text>
            <Text style={{ color: '#0958d9', marginLeft: '8px' }}>
              ç‚¹å‡»æ¨¡å—åç§°å±•å¼€æŸ¥çœ‹è¯¥æ¨¡å—ä¸‹çš„é€‰æ‰‹åˆ—è¡¨ï¼Œç„¶åå¯ä»¥æŸ¥çœ‹ç­”é¢˜å’Œè¿›è¡Œè¯„åˆ†
            </Text>
          </div>
          
          <Table
            loading={loading}
            columns={moduleColumns}
            dataSource={modules}
            rowKey="id"
            expandable={{
              expandedRowKeys: expandedRows,
              onExpand: handleExpand,
              expandedRowRender: expandedRowRender
            }}
            pagination={{ pageSize: 10 }}
          />

          {/* è¯¦ç»†è¯„åˆ†æŠ½å±‰ */}
          <Drawer
            title={`è¯¦ç»†è¯„åˆ† - ${selectedContestant?.contestant_name || ''}`}
            placement="right"
            open={drawerVisible}
            onClose={() => setDrawerVisible(false)}
            width="80%"
          >
            {selectedContestant && selectedModule && (
              <div>
                {/* é€‰æ‰‹åŸºæœ¬ä¿¡æ¯ */}
                <Card size="small" style={{ marginBottom: 16 }}>
                  <Descriptions column={2} size="small">
                    <Descriptions.Item label="é€‰æ‰‹å§“å">{selectedContestant.contestant_name}</Descriptions.Item>
                    <Descriptions.Item label="ç”¨æˆ·å">{selectedContestant.username}</Descriptions.Item>
                    <Descriptions.Item label="æ¨¡å—çŠ¶æ€">
                      <Tag color={statusConfig[selectedModule.status]?.color}>
                        {statusConfig[selectedModule.status]?.text}
                      </Tag>
                    </Descriptions.Item>
                  </Descriptions>
                </Card>

                {/* ç­”é¢˜æ–‡ä»¶ */}
                {selectedContestant.answerAttachments && selectedContestant.answerAttachments.length > 0 && (
                  <Card title="ç­”é¢˜æ–‡ä»¶" size="small" style={{ marginBottom: 16 }}>
                    <div>
                      {selectedContestant.answerAttachments.map(attachment => (
                        <div key={attachment.id} style={{ marginBottom: 8 }}>
                          <Button 
                            type="link" 
                            onClick={() => window.open(`/attachments/download?filepath=${encodeURIComponent(attachment.filepath)}`, '_blank')}
                          >
                            {attachment.filename}
                          </Button>
                          <Text type="secondary" style={{ marginLeft: 16 }}>
                            ä¸Šä¼ æ—¶é—´: {new Date(attachment.created_at).toLocaleString()}
                          </Text>
                        </div>
                      ))}
                    </div>
                  </Card>
                )}

                {/* è¯¦ç»†è¯„åˆ†é¡¹ */}
                <Card title="è¯„åˆ†è¯¦æƒ…" size="small">
                  {(() => {
                    const validItems = selectedContestant.item_results.filter(item => item.id || item.scoring_item_id);
                    console.log('é€‰æ‰‹è¯„åˆ†è®°å½•:', selectedContestant.item_results);
                    console.log('æœ‰æ•ˆè¯„åˆ†é¡¹æ•°é‡:', validItems.length);
                    return validItems.length === 0;
                  })() ? (
                    <div style={{ textAlign: 'center', padding: 40 }}>
                      <Text type="secondary">è¯¥é€‰æ‰‹å°šæœªåˆ›å»ºè¯„åˆ†è®°å½•</Text>
                      <br />
                      <Button 
                        type="primary" 
                        onClick={handleCreateScoringRecord}
                        disabled={selectedModule.status === 'scoring_finished'}
                        style={{ marginTop: 16 }}
                      >
                        åˆ›å»ºè¯„åˆ†è®°å½•
                      </Button>
                    </div>
                  ) : null}

                  {/* æ€»åˆ†æ±‡æ€» - åªåœ¨æœ‰è¯„åˆ†è®°å½•æ—¶æ˜¾ç¤º */}
                  {selectedContestant.item_results.filter(item => item.id || item.scoring_item_id).length > 0 && (
                    <>

                        <Table
                          dataSource={selectedContestant.item_results.filter(item => item.id || item.scoring_item_id)}
                          columns={[
                        {
                          title: 'åºå·',
                          key: 'index',
                          width: 60,
                          render: (_, record, index) => index + 1
                        },
                        {
                          title: 'è¯„åˆ†é¡¹',
                          dataIndex: 'description',
                          key: 'description',
                          width: 250,
                          render: (text) => (
                            <div 
                              dangerouslySetInnerHTML={{ __html: text }} 
                              style={{ maxWidth: '240px', overflow: 'hidden' }}
                            />
                          )
                        },
                        {
                          title: 'ç±»å‹',
                          dataIndex: 'evaluation_type',
                          key: 'evaluation_type',
                          width: 80,
                          render: (type) => (
                            <Tag color={type === 'objective' ? 'blue' : 'green'}>
                              {type === 'objective' ? 'å®¢è§‚' : 'ä¸»è§‚'}
                            </Tag>
                          )
                        },
                        {
                          title: 'æ»¡åˆ†',
                          dataIndex: 'max_score',
                          key: 'max_score',
                          width: 80,
                          render: (score) => <Text strong>{score}</Text>
                        },
                        {
                          title: 'AIè¯„åˆ†',
                          dataIndex: 'ai_score',
                          key: 'ai_score',
                          width: 90,
                          render: (score) => (
                            score !== null && score !== undefined ? (
                              <Tag color="blue">{parseFloat(score).toFixed(1)}</Tag>
                            ) : (
                              <Text type="secondary">æœªè¯„åˆ†</Text>
                            )
                          )
                        },
                        {
                          title: 'AIè¯„ä¼°å»ºè®®',
                          dataIndex: 'ai_suggestion',
                          key: 'ai_suggestion',
                          width: 200,
                          render: (suggestion) => (
                            suggestion ? (
                              <div 
                                style={{
                                  fontSize: '12px',
                                  color: '#666',
                                  backgroundColor: '#f6f8fa',
                                  padding: '6px 8px',
                                  borderRadius: '4px',
                                  maxWidth: '190px',
                                  overflow: 'hidden',
                                  textOverflow: 'ellipsis',
                                  whiteSpace: 'nowrap',
                                  cursor: 'help'
                                }}
                                title={suggestion}
                              >
                                {suggestion}
                              </div>
                            ) : (
                              <Text type="secondary" style={{ fontSize: '12px' }}>æš‚æ— å»ºè®®</Text>
                            )
                          )
                        },
                        {
                          title: 'è£åˆ¤è¯„åˆ†',
                          dataIndex: 'judge_score',
                          key: 'judge_score',
                          width: 120,
                          render: (score, record) => (
                            <InputNumber
                              min={0}
                              max={record.max_score}
                              step={0.01}
                              value={score}
                              onChange={(val) => handleUpdateScore(selectedModule.id, selectedContestant.contestant_id, record.scoring_item_id || record.id, val)}
                              disabled={selectedModule.status === 'scoring_finished'}
                              style={{ width: 100 }}
                              placeholder="0"
                            />
                          )
                        },
                        {
                          title: 'è¯„åˆ†å·®å¼‚',
                          key: 'score_diff',
                          width: 90,
                          render: (_, record) => {
                            const aiScore = parseFloat(record.ai_score) || 0;
                            const judgeScore = parseFloat(record.judge_score) || 0;
                            const diff = Math.abs(aiScore - judgeScore);
                            
                            if (record.ai_score === null || record.judge_score === null) {
                              return <Text type="secondary">-</Text>;
                            }
                            
                            const color = diff <= 2 ? '#52c41a' : diff <= 5 ? '#faad14' : '#f5222d';
                            return (
                              <Text style={{ color, fontWeight: 'bold' }}>
                                {diff.toFixed(1)}
                              </Text>
                            );
                          }
                        }
                      ]}
                      pagination={false}
                      size="small"
                      rowKey={(record) => record.id || record.scoring_item_id || Math.random()}
                      scroll={{ x: 1000 }}
                    />
                    </>
                  )}
                </Card>
              </div>
            )}
          </Drawer>
        </div>
      );
    }

    // é€‰æ‰‹ä¸“ç”¨ç•Œé¢
    function ContestantInterface({ user, onLogout }) {
      const [currentModule, setCurrentModule] = useState(null);
      const [problemAttachments, setProblemAttachments] = useState([]);
      const [answerAttachments, setAnswerAttachments] = useState([]);
      const [loading, setLoading] = useState(false);

      const loadInProgressModule = async () => {
        setLoading(true);
        try {
          const response = await axios.get('/modules');
          const inProgressModules = response.data.filter(module => module.status === 'in_progress');
          
          if (inProgressModules.length > 0) {
            setCurrentModule(inProgressModules[0]);
            loadProblemAttachments(inProgressModules[0].id);
            loadAnswerAttachments(inProgressModules[0].id, user.id);
          } else {
            setCurrentModule(null);
          }
        } catch (error) {
          message.error('åŠ è½½æ¨¡å—å¤±è´¥');
        } finally {
          setLoading(false);
        }
      };

      const loadProblemAttachments = async (moduleId) => {
        try {
          const response = await axios.get(`/attachments/modules/${moduleId}/problem`);
          setProblemAttachments(response.data);
        } catch (error) {
          console.error('åŠ è½½èµ›é¢˜é™„ä»¶å¤±è´¥:', error);
          setProblemAttachments([]);
        }
      };

      const loadAnswerAttachments = async (moduleId, contestantId) => {
        try {
          const response = await axios.get(`/attachments/modules/${moduleId}/contestants/${contestantId}/answer`);
          setAnswerAttachments(response.data);
        } catch (error) {
          console.error('åŠ è½½ç­”é¢˜é™„ä»¶å¤±è´¥:', error);
          setAnswerAttachments([]);
        }
      };

      const handleUploadAnswer = async (info) => {
        if (info.file.status === 'done') {
          message.success('ç­”é¢˜ä¸Šä¼ æˆåŠŸ');
          loadAnswerAttachments(currentModule.id, user.id);
        } else if (info.file.status === 'error') {
          message.error('ç­”é¢˜ä¸Šä¼ å¤±è´¥');
        }
      };

      const handleDeleteAnswer = async (id) => {
        try {
          await axios.delete(`/attachments/answer/${id}`);
          message.success('åˆ é™¤æˆåŠŸ');
          loadAnswerAttachments(currentModule.id, user.id);
        } catch (error) {
          message.error('åˆ é™¤å¤±è´¥');
        }
      };

      const handleDownload = (filepath, filename) => {
        window.open(`/api/attachments/download?filepath=${encodeURIComponent(filepath)}`);
      };

      useEffect(() => {
        loadInProgressModule();
        // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„è¿›è¡Œä¸­æ¨¡å—
        const interval = setInterval(loadInProgressModule, 30000);
        return () => clearInterval(interval);
      }, []);

      if (loading) {
        return (
          <div style={{ 
            display: 'flex', 
            justifyContent: 'center', 
            alignItems: 'center', 
            minHeight: '100vh' 
          }}>
            <Card>
              <div style={{ textAlign: 'center', padding: '20px' }}>
                <div>æ­£åœ¨åŠ è½½æ¯”èµ›ä¿¡æ¯...</div>
              </div>
            </Card>
          </div>
        );
      }

      if (!currentModule) {
        return (
          <Layout style={{ 
            minHeight: '100vh',
            background: 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)'
          }}>
            <Header style={{ 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'space-between',
              padding: '0 24px',
              height: '64px',
              lineHeight: '64px',
              boxShadow: '0 2px 8px rgba(0,0,0,0.15)'
            }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px', height: '64px' }}>
                <div style={{
                  width: '36px',
                  height: '36px',
                  background: 'rgba(255, 255, 255, 0.2)',
                  borderRadius: '8px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  flexShrink: 0
                }}>
                  <span style={{ fontSize: '18px' }}>ğŸ†</span>
                </div>
                <div style={{ color: 'white', fontSize: '16px', fontWeight: 'bold' }}>
                  ä¸–ç•ŒæŠ€èƒ½å¤§èµ› - é€‰æ‰‹ç«¯
                </div>
              </div>
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px', height: '64px' }}>
                <div style={{
                  background: 'rgba(255, 255, 255, 0.15)',
                  padding: '6px 12px',
                  borderRadius: '16px',
                  height: '32px',
                  display: 'flex',
                  alignItems: 'center'
                }}>
                  <span style={{ fontSize: '14px', color: 'white' }}>ğŸ‘¤ {user.name}</span>
                </div>
                <Button 
                  type="link" 
                  onClick={onLogout} 
                  style={{ 
                    color: 'white',
                    background: 'rgba(255, 255, 255, 0.15)',
                    padding: '6px 12px',
                    borderRadius: '6px',
                    height: '32px',
                    fontSize: '13px'
                  }}
                >
                  ğŸšª é€€å‡º
                </Button>
              </div>
            </Header>
            <Content style={{ 
              display: 'flex', 
              justifyContent: 'center', 
              alignItems: 'center', 
              minHeight: 'calc(100vh - 64px)',
              padding: '24px'
            }}>
              <Card style={{ 
                width: 500, 
                textAlign: 'center',
                borderRadius: '16px',
                boxShadow: '0 8px 24px rgba(0,0,0,0.12)'
              }}>
                <div style={{ fontSize: '64px', marginBottom: '24px' }}>â³</div>
                <Title level={3}>æš‚æ— è¿›è¡Œä¸­çš„æ¨¡å—</Title>
                <Text type="secondary" style={{ fontSize: '16px' }}>
                  æ¯”èµ›å°šæœªå¼€å§‹ï¼Œè¯·è€å¿ƒç­‰å¾…
                </Text>
                <div style={{ marginTop: '32px' }}>
                  <Button 
                    type="primary" 
                    size="large" 
                    onClick={loadInProgressModule}
                    icon={<span style={{ marginRight: '8px' }}>ğŸ”„</span>}
                  >
                    åˆ·æ–°çŠ¶æ€
                  </Button>
                </div>
              </Card>
            </Content>
          </Layout>
        );
      }

      return (
        <Layout style={{ 
          minHeight: '100vh',
          background: 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)'
        }}>
          <Header style={{ 
            display: 'flex', 
            alignItems: 'center', 
            justifyContent: 'space-between',
            padding: '0 24px',
            height: '64px',
            lineHeight: '64px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.15)'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', height: '64px' }}>
              <div style={{
                width: '36px',
                height: '36px',
                background: 'rgba(255, 255, 255, 0.2)',
                borderRadius: '8px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                flexShrink: 0
              }}>
                <span style={{ fontSize: '18px' }}>ğŸ†</span>
              </div>
              <div style={{ lineHeight: '1.4' }}>
                <div style={{ color: 'white', fontSize: '16px', fontWeight: 'bold' }}>
                  {currentModule.name}
                </div>
                <div style={{ color: 'rgba(255,255,255,0.8)', fontSize: '11px' }}>
                  æ¯”èµ›è¿›è¡Œä¸­ Â· æ—¶é•¿: {currentModule.duration_minutes} åˆ†é’Ÿ
                </div>
              </div>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', height: '64px' }}>
              <div style={{
                background: 'rgba(255, 255, 255, 0.15)',
                padding: '6px 12px',
                borderRadius: '16px',
                height: '32px',
                display: 'flex',
                alignItems: 'center'
              }}>
                <span style={{ fontSize: '14px', color: 'white' }}>ğŸ‘¤ {user.name}</span>
              </div>
              <Button 
                type="link" 
                onClick={onLogout} 
                style={{ 
                  color: 'white',
                  background: 'rgba(255, 255, 255, 0.15)',
                  padding: '6px 12px',
                  borderRadius: '6px',
                  height: '32px',
                  fontSize: '13px'
                }}
              >
                ğŸšª é€€å‡º
              </Button>
            </div>
          </Header>
          <Content style={{ padding: '24px' }}>
            {/* æç¤ºä¿¡æ¯ */}
            <div style={{
              marginBottom: '24px',
              padding: '16px 24px',
              background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
              borderRadius: '12px',
              color: 'white',
              boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
            }}>
              <Text style={{ color: 'white', fontSize: '16px', fontWeight: 500 }}>
                ğŸ“ è¯·ä¸‹è½½èµ›é¢˜é™„ä»¶ï¼Œå®Œæˆç­”é¢˜åä¸Šä¼ æ‚¨çš„ä½œå“æ–‡ä»¶
              </Text>
            </div>

            <Row gutter={24}>
              <Col span={12}>
                <Card 
                  title={<span style={{ fontSize: '16px', fontWeight: 600 }}>ğŸ“„ èµ›é¢˜é™„ä»¶</span>}
                  style={{ 
                    height: '100%',
                    borderRadius: '12px',
                    boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
                  }}
                  headStyle={{
                    background: 'linear-gradient(135deg, #f8fafc, #f1f5f9)'
                  }}
                >
                  {problemAttachments.length === 0 ? (
                    <div style={{ 
                      textAlign: 'center', 
                      padding: '60px 40px',
                      color: '#999'
                    }}>
                      <div style={{ fontSize: '48px', marginBottom: '16px' }}>ğŸ“­</div>
                      <Text type="secondary">æš‚æ— èµ›é¢˜æ–‡ä»¶</Text>
                    </div>
                  ) : (
                    <Table
                      dataSource={problemAttachments}
                      columns={[
                        { title: 'æ–‡ä»¶å', dataIndex: 'filename', key: 'filename' },
                        {
                          title: 'ä¸Šä¼ æ—¶é—´',
                          dataIndex: 'created_at',
                          key: 'created_at',
                          render: (val) => dayjs(val).format('YYYY-MM-DD HH:mm')
                        },
                        {
                          title: 'æ“ä½œ',
                          key: 'action',
                          render: (_, record) => (
                            <Button
                              size="small"
                              onClick={() => handleDownload(record.filepath, record.filename)}
                            >
                              ä¸‹è½½
                            </Button>
                          )
                        }
                      ]}
                      rowKey="id"
                      pagination={false}
                      size="small"
                    />
                  )}
                </Card>
              </Col>
              <Col span={12}>
                <Card 
                  title={<span style={{ fontSize: '16px', fontWeight: 600 }}>âœï¸ æˆ‘çš„ç­”é¢˜</span>}
                  style={{ 
                    height: '100%',
                    borderRadius: '12px',
                    boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
                  }}
                  headStyle={{
                    background: 'linear-gradient(135deg, #f8fafc, #f1f5f9)'
                  }}
                >
                  <div style={{ marginBottom: 16 }}>
                    <Upload
                      name="file"
                      action={`/api/attachments/modules/${currentModule.id}/answer`}
                      headers={{
                        Authorization: axios.defaults.headers.common['Authorization']
                      }}
                      onChange={handleUploadAnswer}
                      multiple
                    >
                      <Button 
                        type="primary" 
                        size="large"
                        block
                        icon={<span style={{ marginRight: '8px' }}>ğŸ“¤</span>}
                      >
                        ä¸Šä¼ ç­”é¢˜æ–‡ä»¶
                      </Button>
                    </Upload>
                  </div>
                  {answerAttachments.length === 0 ? (
                    <div style={{ 
                      textAlign: 'center', 
                      padding: '60px 40px',
                      color: '#999'
                    }}>
                      <div style={{ fontSize: '48px', marginBottom: '16px' }}>ğŸ“‚</div>
                      <Text type="secondary">æš‚æœªä¸Šä¼ ç­”é¢˜æ–‡ä»¶</Text>
                    </div>
                  ) : (
                    <Table
                      dataSource={answerAttachments}
                      columns={[
                        { title: 'æ–‡ä»¶å', dataIndex: 'filename', key: 'filename' },
                        {
                          title: 'ä¸Šä¼ æ—¶é—´',
                          dataIndex: 'created_at',
                          key: 'created_at',
                          render: (val) => dayjs(val).format('YYYY-MM-DD HH:mm')
                        },
                        {
                          title: 'æ“ä½œ',
                          key: 'action',
                          render: (_, record) => (
                            <Space>
                              <Button
                                size="small"
                                onClick={() => handleDownload(record.filepath, record.filename)}
                              >
                                ä¸‹è½½
                              </Button>
                              <Popconfirm
                                title="ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ"
                                onConfirm={() => handleDeleteAnswer(record.id)}
                              >
                                <Button size="small" danger>åˆ é™¤</Button>
                              </Popconfirm>
                            </Space>
                          )
                        }
                      ]}
                      rowKey="id"
                      pagination={false}
                      size="small"
                    />
                  )}
                </Card>
              </Col>
            </Row>
          </Content>
        </Layout>
      );
    }

    // ä¸»åº”ç”¨
    function App() {
      const [user, setUser] = useState(null);
      const [selectedMenu, setSelectedMenu] = useState('competitions');

      // ä»URL hashè·å–è·¯ç”±
      const getRouteFromHash = () => {
        const hash = window.location.hash.slice(1); // ç§»é™¤ # å·
        return hash || null;
      };

      // è®¾ç½®URL hash
      const setRouteHash = (route) => {
        window.location.hash = route;
      };

      useEffect(() => {
        const token = localStorage.getItem('token');
        if (token) {
          axios.get('/auth/profile')
            .then(response => {
              const userData = response.data.user;
              setUser(userData);
              
              // ä»URL hashè·å–åˆå§‹è·¯ç”±
              const hashRoute = getRouteFromHash();
              if (hashRoute && ['competitions', 'events', 'modules', 'scoring', 'users'].includes(hashRoute)) {
                setSelectedMenu(hashRoute);
              } else {
                // æ ¹æ®ç”¨æˆ·è§’è‰²è®¾ç½®é»˜è®¤èœå•
                const defaultMenu = userData.role === 'judge' ? 'scoring' : 'competitions';
                setSelectedMenu(defaultMenu);
                setRouteHash(defaultMenu);
              }
            })
            .catch(() => {
              localStorage.removeItem('token');
              setAuthToken(null);
            });
        }
      }, []);

      // ç›‘å¬æµè§ˆå™¨å‰è¿›åé€€
      useEffect(() => {
        const handleHashChange = () => {
          const route = getRouteFromHash();
          if (route && ['competitions', 'events', 'modules', 'scoring', 'users'].includes(route)) {
            setSelectedMenu(route);
          }
        };

        window.addEventListener('hashchange', handleHashChange);
        return () => window.removeEventListener('hashchange', handleHashChange);
      }, []);

      const handleLogout = () => {
        setUser(null);
        setAuthToken(null);
      };

      if (!user) {
        return <LoginPage onLogin={setUser} />;
      }

      // é€‰æ‰‹ä½¿ç”¨ä¸“ç”¨ç•Œé¢
      if (user.role === 'contestant') {
        return <ContestantInterface user={user} onLogout={handleLogout} />;
      }

      const menuItems = [
        { 
          key: 'competitions', 
          label: (
            <div style={{ textAlign: 'center', padding: '8px 0' }}>
              <div style={{ fontSize: '24px', marginBottom: '4px' }}>ğŸ†</div>
              <div style={{ fontSize: '12px' }}>èµ›äº‹ç®¡ç†</div>
            </div>
          ),
          roles: ['admin', 'chief_judge'] 
        },
        { 
          key: 'events', 
          label: (
            <div style={{ textAlign: 'center', padding: '8px 0' }}>
              <div style={{ fontSize: '24px', marginBottom: '4px' }}>ğŸ“‹</div>
              <div style={{ fontSize: '12px' }}>èµ›é¡¹ç®¡ç†</div>
            </div>
          ),
          roles: ['admin', 'chief_judge'] 
        },
        { 
          key: 'modules', 
          label: (
            <div style={{ textAlign: 'center', padding: '8px 0' }}>
              <div style={{ fontSize: '24px', marginBottom: '4px' }}>ğŸ“¦</div>
              <div style={{ fontSize: '12px' }}>æ¨¡å—ç®¡ç†</div>
            </div>
          ),
          roles: ['admin', 'chief_judge'] 
        },
        { 
          key: 'scoring', 
          label: (
            <div style={{ textAlign: 'center', padding: '8px 0' }}>
              <div style={{ fontSize: '24px', marginBottom: '4px' }}>âœï¸</div>
              <div style={{ fontSize: '12px' }}>è¯„åˆ†ç®¡ç†</div>
            </div>
          ),
          roles: ['admin', 'chief_judge', 'judge'] 
        },
        { 
          key: 'users', 
          label: (
            <div style={{ textAlign: 'center', padding: '8px 0' }}>
              <div style={{ fontSize: '24px', marginBottom: '4px' }}>ğŸ‘¥</div>
              <div style={{ fontSize: '12px' }}>ç”¨æˆ·ç®¡ç†</div>
            </div>
          ),
          roles: ['admin'] 
        },
      ].filter(item => item.roles.includes(user.role));

      const renderContent = () => {
        switch (selectedMenu) {
          case 'users':
            return <UserManagement />;
          case 'competitions':
            return <CompetitionManagement user={user} />;
          case 'events':
            return <EventManagement user={user} />;
          case 'modules':
            return <ModuleManagement user={user} />;
          case 'scoring':
            return <ScoringManagement user={user} />;
          default:
            return <div>é€‰æ‹©ä¸€ä¸ªèœå•é¡¹</div>;
        }
      };

      return (
        <Layout style={{ minHeight: '100vh', background: 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)' }}>
          <Header style={{ 
            display: 'flex', 
            alignItems: 'center', 
            justifyContent: 'space-between',
            padding: '0 24px',
            height: '64px',
            lineHeight: '64px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.15)'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', height: '64px' }}>
              <div style={{
                width: '36px',
                height: '36px',
                background: 'rgba(255, 255, 255, 0.2)',
                borderRadius: '8px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                flexShrink: 0
              }}>
                <span style={{ fontSize: '18px' }}>ğŸ†</span>
              </div>
              <div style={{ lineHeight: '1.4' }}>
                <div style={{ color: 'white', fontSize: '16px', fontWeight: 'bold' }}>
                  ä¸–ç•ŒæŠ€èƒ½å¤§èµ›
                </div>
                <div style={{ color: 'rgba(255,255,255,0.8)', fontSize: '11px' }}>
                  AI æ™ºèƒ½è¯„åˆ†ç³»ç»Ÿ
                </div>
              </div>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', height: '64px' }}>
              <div style={{
                background: 'rgba(255, 255, 255, 0.15)',
                padding: '6px 12px',
                borderRadius: '16px',
                display: 'flex',
                alignItems: 'center',
                gap: '6px',
                height: '32px',
                maxWidth: '200px'
              }}>
                <span style={{ fontSize: '14px', flexShrink: 0 }}>ğŸ‘¤</span>
                <span style={{ 
                  fontWeight: 500, 
                  fontSize: '14px', 
                  color: 'white',
                  whiteSpace: 'nowrap',
                  overflow: 'hidden',
                  textOverflow: 'ellipsis',
                  maxWidth: '80px'
                }}>{user.name}</span>
                <Tag style={{ 
                  margin: 0,
                  background: 'rgba(255, 255, 255, 0.25)',
                  color: 'white',
                  border: 'none',
                  fontSize: '11px',
                  padding: '0 6px',
                  height: '18px',
                  lineHeight: '18px',
                  flexShrink: 0
                }}>
                  {user.role === 'admin' ? 'ç®¡ç†å‘˜' : 
                   user.role === 'chief_judge' ? 'è£åˆ¤é•¿' : 
                   user.role === 'judge' ? 'è£åˆ¤' : 'é€‰æ‰‹'}
                </Tag>
              </div>
              <Button 
                type="link" 
                onClick={handleLogout} 
                style={{ 
                  color: 'white',
                  background: 'rgba(255, 255, 255, 0.15)',
                  padding: '6px 12px',
                  borderRadius: '6px',
                  height: '32px',
                  fontSize: '13px'
                }}
              >
                ğŸšª é€€å‡º
              </Button>
            </div>
          </Header>
          <Layout>
            <Sider width={88} style={{ 
              background: '#fff',
              boxShadow: '2px 0 8px rgba(0,0,0,0.05)'
            }}>
              <Menu
                mode="inline"
                selectedKeys={[selectedMenu]}
                style={{ 
                  height: '100%',
                  borderRight: 0,
                  paddingTop: '8px'
                }}
                items={menuItems}
                onSelect={({ key }) => {
                  setSelectedMenu(key);
                  setRouteHash(key);
                }}
              />
            </Sider>
            <Layout style={{ padding: '24px', background: 'transparent' }}>
              <Content
                style={{
                  padding: 32,
                  margin: 0,
                  minHeight: 280,
                  background: '#fff',
                  borderRadius: '12px',
                  boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                }}
              >
                {renderContent()}
              </Content>
            </Layout>
          </Layout>
        </Layout>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
