**需求文档**

---

**项目名称**：世界职业技能大赛 AI 评分系统

**目标**：构建一个基于 Node.js 的前后端一体化系统，使用 PostgreSQL 作为数据库，支持用户管理、赛事管理、赛项管理、模块管理及 AI 插件化评分功能。

---

### 一、技术栈要求

- **后端语言**：Node.js（建议使用 Express 或 Fastify）
- **前端语言**：Node.js 生态（如使用 Vite + React 或 Svelte，但可简化为服务端渲染或 API-only 模式）
- **数据库**：PostgreSQL
- **AI 模型调用**：通过 OpenAI 协议调用 `qwen3-vl-32b` 多模态模型（LVM）
- **部署要求**：单机部署友好，依赖尽量少，配置简单

---

### 二、核心模块与数据结构

#### 1. 用户管理（User）

- 用户类型：`admin`（管理员）、`chief_judge`（裁判长）、`judge`（裁判）、`contestant`（选手）
- 权限规则：
  - `admin`：拥有全部数据读写权限
  - `chief_judge`：可访问管理员分配给其的赛项及其下所有数据（裁判、选手、模块、评分标准）
  - `judge`：仅可访问裁判长分配给其的赛项中指定选手的答题内容和评分录入权限
  - `contestant`：仅可查看自己参与的模块状态、赛题（仅“进行中”状态）、提交答题附件

#### 2. 赛事管理（Competition）

- 字段：
  - `id`（主键）
  - `name`（赛事名称，如“第三届中华人民共和国职业技能大赛”）
  - `start_time`, `end_time`
- 关联：一对多 → 赛项（Event）

#### 3. 赛项管理（Event）

- 字段：
  - `id`
  - `competition_id`（外键）
  - `name`（如“移动应用开发”）
  - `start_time`, `end_time`
- 关联：
  - 多对多 → `chief_judge`（裁判长）
  - 多对多 → `judge`（裁判）
  - 多对多 → `contestant`（选手）
  - 一对多 → `module`（模块）

#### 4. 模块管理（Module）

- 字段：
  - `id`
  - `event_id`（外键）
  - `name`（如“APP原型设计”）
  - `duration_minutes`（比赛时长，单位分钟）
  - `status`：`pending`（未开始）、`in_progress`（进行中）、`finished`（结束）
- 子资源：
  - **赛题附件**（ProblemAttachment）：多个文件（支持上传/下载）
  - **答题附件**（AnswerAttachment）：每个选手可提交多个文件
  - **评分标准**（ScoringCriteria）：
    - 包含多个 **评分项（ScoringItem）**
    - 每个 ScoringItem 字段：
      - `id`
      - `description`（富文本，支持 HTML 或 Markdown）
      - `evaluation_type`：`subjective` / `objective`
      - `max_score`：Decimal（两位小数）

> **访问控制**：
> - 仅当 `status = in_progress` 时，选手可查看赛题并提交答题
> - 评分标准仅对 `admin` 和 `chief_judge` 可见

#### 5. 评分管理（Scoring）

- 每个选手在每个模块下有一条评分记录（ScoringRecord）
- 每个 ScoringRecord 包含多个 ScoringItemResult：
  - `scoring_item_id`
  - `judge_score`（裁判打分，可为空）
  - `ai_suggestion`（AI 评估建议，文本）
  - `ai_score`（AI 打分，仅用于 objective 类型）

- **权限**：
  - 裁判仅能查看和编辑分配给自己的选手的 ScoringRecord

#### 6. AI 评估插件机制

- 设计插件注册表：`ai_evaluators: Map<module_id, Function>`
- 模块状态变为 `finished` 时，系统检查是否存在注册的 AI 评估函数
  - 若存在，调用该函数，传入：
    - 评分标准（ScoringCriteria）
    - 赛题附件列表
    - 选手答题附件列表
  - 函数返回：每个评分项的 `ai_score`（objective）或 `ai_suggestion`（subjective）

- **示例插件：APP原型设计**
  - 假设选手提交 `01.jpeg` 到 `10.jpeg`
  - 每个评分项会指定评估哪张图（如“评估 03.jpeg 的导航结构合理性”）
  - 调用 `qwen3-vl-32b`（通过 OpenAI 兼容 API）：
    - 输入：图片 + 评分项描述
    - 输出：
      - 若为 `objective`：返回 0.00–max_score 的数值
      - 若为 `subjective`：返回一段评估建议文本
  - 结果写入对应 ScoringItemResult

---

### 三、API 与数据流简要说明（供代码生成参考）

- 用户登录 / 权限校验中间件
- 赛事 CRUD（仅 admin）
- 赛项 CRUD + 分配裁判长/裁判/选手（admin 或 chief_judge）
- 模块 CRUD（chief_judge）
- 附件上传/下载（按权限控制）
- 模块状态自动流转（可定时任务或手动触发）
- 评分录入接口（judge）
- AI 评估触发点：模块结束时自动调用插件

---

### 四、特别说明（给代码生成器）

- 需要实现完整 UI和后端 API 和 AI 插件机制
- UI直接用antd即可，赛事和赛项管理页面可简化，重点在模块和评分管理，对状态字段、AI评估字段等不同状态颜色需要考虑
- 富文本字段可用 `TEXT` 类型存储（如 HTML）
- 文件存储可使用本地磁盘（`/uploads`）或模拟，无需集成云存储
- AI 调用封装为可配置函数，示例插件必须实现
- 权限校验需贯穿所有接口（基于用户角色 + 数据归属）

--- 

**输出要求**：生成可运行的 Node.js 项目结构，包含数据库迁移脚本、API 路由、权限中间件、AI 插件注册机制及“APP原型设计”示例评估器。

### 五、产品经理原始需求供参考
实现一个世界职业技能大赛的AI评分系统，主要分为用户管理、赛事管理、赛项管理、模块管理。主要功能：
- 用户管理：管理员、裁判长、裁判、选手，管理员具备全部权限，裁判长具备由管理员分配的的赛项的全部信息，裁判具备由裁判长分配的赛项选手的全部信息
- 赛事管理：赛事名称（如：第三届中华人民共和国职业技能大赛）、开始时间、结束时间，可关联查询到该赛事的所有赛项
- 赛项管理：赛项名称（如：移动应用开发、网站开发等）、开始时间、结束时间，可关联查询到该赛项下的裁判长（多个）、裁判（多个）、选手（多个）、模块（多个）等信息
- 模块管理：模块名称（如：APP原型设计、APP界面实现、APP功能开发等）、比赛时长、状态（未开始、进行中、结束）
 - 每个模块包含：赛题、答题，两者均为附件（可多个文件），还包含评分标准
 - 评分标准：包含多个评分项，每个评分项包含评分项ID、评分标准（描述字段支持富文本）、评估类型（主观和客观）、配分（两位小数）
 - 只有进行中的模块，裁判和选手才可以看到赛题和提交答题结果。评分标准除了管理员和裁判长外，其他人都无法查看
- 评分管理：基于各模块的评分标准对每个选手的答题结果进行评分，评分有两种手段，AI预评分、AI评估建议、裁判评分。
 - 裁判只可以看到分配到自己权限范围内的选手的答题和评分权限。
 - 裁判可以在裁判评分栏录入对应评分项的得分
 - AI评分和评估建议每个模块不一样，所以需要插件化管理，代码插件实现时通过模块ID进行注册，如果某个模块能够找到注册的AI评估程序，则模块结束后调用评估程序进行评估，调用时需要传入评分标准、赛题、答题给评估程序。
- AI评估程序先实现一个样例：APP原型设计
 - 选手会提交01-10.jpeg10张图，评分项中会明确评估哪张图的具体要求
 - 如果评分项类型是“主观”，则调用LVM模型由模型给主观评估建议，填入AI评估建议中。如果是“客观”，则调用LVM模型给出打分结果
 - 模型采用openai协议调用qwen3-vl-32b
- 技术架构：部署简单点，可以考虑前后端都用nodejs，数据库pg
